<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="auth-token" content="<%= locals.token || '' %>">
    <title>Admin - Verification Requests</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/tailwind.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <%- include('partials/header') %>
        
        <main class="flex-grow py-10">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Professional Verification Requests</h1>
                    
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <select id="status-filter" class="bg-white border border-gray-300 rounded-md px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Requests</option>
                                <option value="pending" selected>Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        
                        <button id="refresh-btn" class="bg-white border border-gray-300 p-2 rounded-md hover:bg-gray-50" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Professional Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requests-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Request rows will be inserted here -->
                                <tr class="text-center text-gray-500">
                                    <td colspan="5" class="px-6 py-12">Loading verification requests...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
                        <div>
                            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span> requests
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-1"></i> Previous
                            </button>
                            <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                Next <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Verification Request Modal -->
        <div id="verification-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-semibold" id="modal-title">Verification Request</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-10rem)]">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-3 text-gray-800">User Information</h4>
                            <div class="bg-gray-50 rounded-md p-4">
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Name</div>
                                    <div id="user-name" class="font-medium"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Email</div>
                                    <div id="user-email" class="font-medium"></div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">User ID</div>
                                    <div id="user-id" class="font-medium"></div>
                                </div>
                            </div>
                            
                            <h4 class="font-semibold mb-3 mt-5 text-gray-800">Professional Info</h4>
                            <div class="bg-gray-50 rounded-md p-4">
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Type</div>
                                    <div id="professional-type" class="font-medium"></div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">License Number</div>
                                    <div id="license-number" class="font-medium"></div>
                                </div>
                            </div>
                            
                            <h4 class="font-semibold mb-3 mt-5 text-gray-800">Verification Documents</h4>
                            <div id="documents-container" class="space-y-2">
                                <!-- Documents will be inserted here -->
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-3 text-gray-800">Verification Notes</h4>
                            <div class="bg-gray-50 rounded-md p-4 mb-5">
                                <p id="verification-description" class="text-gray-700"></p>
                            </div>
                            
                            <div id="decision-form">
                                <h4 class="font-semibold mb-3 text-gray-800">Make Decision</h4>
                                <div class="mb-4">
                                    <label for="decision-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Required for rejection)</label>
                                    <textarea id="decision-notes" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <div id="existing-decision" class="bg-gray-50 rounded-md p-4 mb-5 hidden">
                                <h4 class="font-semibold mb-2 text-gray-800">Review Decision</h4>
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Status</div>
                                    <div id="decision-status" class="font-medium"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Reviewer</div>
                                    <div id="reviewer-name" class="font-medium"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="text-sm text-gray-500">Date</div>
                                    <div id="review-date" class="font-medium"></div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Notes</div>
                                    <div id="review-notes" class="font-medium"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="close-modal-btn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                    <button id="reject-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Reject
                    </button>
                    <button id="approve-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Approve
                    </button>
                </div>
            </div>
        </div>
        
        <%- include('partials/footer') %>
    </div>
    
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const requestsTableBody = document.getElementById('requests-table-body');
            const statusFilter = document.getElementById('status-filter');
            const refreshBtn = document.getElementById('refresh-btn');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const showingStart = document.getElementById('showing-start');
            const showingEnd = document.getElementById('showing-end');
            const totalCount = document.getElementById('total-count');
            
            // Modal Elements
            const verificationModal = document.getElementById('verification-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const closeModalBtn2 = document.getElementById('close-modal-btn');
            const approveBtn = document.getElementById('approve-btn');
            const rejectBtn = document.getElementById('reject-btn');
            const decisionNotes = document.getElementById('decision-notes');
            const decisionForm = document.getElementById('decision-form');
            const existingDecision = document.getElementById('existing-decision');
            
            // Pagination state
            let currentPage = 0;
            const pageSize = 10;
            let totalRequests = 0;
            let currentRequestId = null;
            let currentRequest = null;
            
            // Initial load
            loadVerificationRequests();
            
            // Event listeners
            statusFilter.addEventListener('change', () => {
                currentPage = 0;
                loadVerificationRequests();
            });
            
            refreshBtn.addEventListener('click', loadVerificationRequests);
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadVerificationRequests();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if ((currentPage + 1) * pageSize < totalRequests) {
                    currentPage++;
                    loadVerificationRequests();
                }
            });
            
            closeModalBtn.addEventListener('click', closeModal);
            closeModalBtn2.addEventListener('click', closeModal);
            
            approveBtn.addEventListener('click', () => processVerificationRequest('approve'));
            rejectBtn.addEventListener('click', () => processVerificationRequest('reject'));
            
            // Functions
            async function loadVerificationRequests() {
                try {
                    requestsTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="5" class="px-6 py-12">Loading verification requests...</td></tr>';
                    
                    const token = document.querySelector('meta[name="auth-token"]')?.content || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('Authentication token not found');
                    }
                    
                    const status = statusFilter.value;
                    let url = '/api/admin/verification-requests';
                    if (status !== 'all') {
                        url += `?status=${status}&page=${currentPage}&limit=${pageSize}`;
                    } else {
                        url += `?page=${currentPage}&limit=${pageSize}`;
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch verification requests');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load verification requests');
                    }
                    
                    renderVerificationRequests(data.requests);
                    
                    // Update pagination
                    totalRequests = data.requests.length;
                    updatePagination({
                        total: totalRequests,
                        page: currentPage,
                        pageSize: pageSize
                    });
                    
                } catch (error) {
                    console.error('Error loading verification requests:', error);
                    requestsTableBody.innerHTML = `<tr class="text-center text-gray-500"><td colspan="5" class="px-6 py-12">Error: ${error.message}</td></tr>`;
                    showError(`Failed to load verification requests: ${error.message}`);
                }
            }
            
            function renderVerificationRequests(requests) {
                if (requests.length === 0) {
                    requestsTableBody.innerHTML = '<tr class="text-center text-gray-500"><td colspan="5" class="px-6 py-12">No verification requests found</td></tr>';
                    return;
                }
                
                requestsTableBody.innerHTML = '';
                
                requests.forEach(request => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50";
                    
                    let statusBadge;
                    if (request.status === 'pending') {
                        statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>';
                    } else if (request.status === 'approved') {
                        statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Approved</span>';
                    } else if (request.status === 'rejected') {
                        statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Rejected</span>';
                    } else {
                        statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Unknown</span>';
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${request.username || 'Unknown'}</div>
                                    <div class="text-sm text-gray-500">${request.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatProfessionalType(request.professional_type)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatDate(request.request_date)}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3 view-request-btn" data-id="${request.id}">
                                View Details
                            </button>
                        </td>
                    `;
                    
                    requestsTableBody.appendChild(row);
                    
                    // Add event listener to view button
                    const viewBtn = row.querySelector('.view-request-btn');
                    viewBtn.addEventListener('click', () => openVerificationModal(request));
                });
            }
            
            function updatePagination(pagination) {
                const { total, page, pageSize } = pagination;
                const start = total === 0 ? 0 : page * pageSize + 1;
                const end = Math.min((page + 1) * pageSize, total);
                
                showingStart.textContent = start;
                showingEnd.textContent = end;
                totalCount.textContent = total;
                
                prevPageBtn.disabled = page === 0;
                nextPageBtn.disabled = end >= total;
            }
            
            function openVerificationModal(request) {
                currentRequestId = request.id;
                currentRequest = request;
                
                // Set user information
                document.getElementById('user-name').textContent = request.username || 'Unknown';
                document.getElementById('user-email').textContent = request.email || 'No email';
                document.getElementById('user-id').textContent = request.user_id || 'Unknown';
                
                // Set professional information
                document.getElementById('professional-type').textContent = formatProfessionalType(request.professional_type);
                document.getElementById('license-number').textContent = request.license_number || 'Not provided';
                
                // Set verification description
                document.getElementById('verification-description').textContent = request.description || 'No additional information provided';
                
                // Set documents
                const documentsContainer = document.getElementById('documents-container');
                documentsContainer.innerHTML = '';
                
                if (request.verification_documents && request.verification_documents.length > 0) {
                    request.verification_documents.forEach((doc, index) => {
                        const docElement = document.createElement('div');
                        docElement.className = 'flex items-center justify-between bg-white border border-gray-200 rounded-md p-3';
                        
                        let fileName = 'Document ' + (index + 1);
                        let fileUrl = '#';
                        
                        if (typeof doc === 'string') {
                            fileName = doc.split('/').pop() || fileName;
                            fileUrl = doc;
                        } else if (doc.url) {
                            fileName = doc.originalName || doc.name || fileName;
                            fileUrl = doc.url;
                        }
                        
                        docElement.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file-alt text-blue-500 mr-3"></i>
                                <span class="text-sm">${fileName}</span>
                            </div>
                            <a href="${fileUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        `;
                        documentsContainer.appendChild(docElement);
                    });
                } else {
                    documentsContainer.innerHTML = '<p class="text-gray-500">No documents provided</p>';
                }
                
                // Handle decision section display
                if (request.status === 'pending') {
                    decisionForm.style.display = 'block';
                    existingDecision.style.display = 'none';
                    approveBtn.style.display = '';
                    rejectBtn.style.display = '';
                } else {
                    decisionForm.style.display = 'none';
                    existingDecision.style.display = 'block';
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                    
                    // Display existing decision
                    document.getElementById('decision-status').textContent = request.status.charAt(0).toUpperCase() + request.status.slice(1);
                    document.getElementById('reviewer-name').textContent = request.reviewer_id || 'Unknown';
                    document.getElementById('review-date').textContent = formatDate(request.review_date) || 'Unknown';
                    document.getElementById('review-notes').textContent = request.review_notes || 'No notes provided';
                }
                
                // Show modal
                verificationModal.classList.remove('hidden');
                verificationModal.classList.add('flex');
            }
            
            function closeModal() {
                verificationModal.classList.add('hidden');
                verificationModal.classList.remove('flex');
                currentRequestId = null;
                currentRequest = null;
                decisionNotes.value = '';
            }
            
            async function processVerificationRequest(action) {
                try {
                    if (!currentRequestId) {
                        showError('No request selected');
                        return;
                    }
                    
                    const token = document.querySelector('meta[name="auth-token"]')?.content || localStorage.getItem('token');
                    if (!token) {
                        throw new Error('Authentication token not found');
                    }
                    
                    // If rejecting, notes are required
                    const notes = decisionNotes.value.trim();
                    if (action === 'reject' && !notes) {
                        showError('Notes are required when rejecting a verification request');
                        return;
                    }
                    
                    // Disable buttons during processing
                    approveBtn.disabled = true;
                    rejectBtn.disabled = true;
                    
                    const endpoint = `/api/admin/verification-requests/${currentRequestId}/${action}`;
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ notes: notes })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed to ${action} verification request`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || `Failed to ${action} verification request`);
                    }
                    
                    // Show success message
                    const message = action === 'approve' 
                        ? 'Verification request approved successfully' 
                        : 'Verification request rejected successfully';
                    
                    // Close modal and refresh
                    closeModal();
                    loadVerificationRequests();
                    
                    // Show toast or alert
                    alert(message);
                    
                } catch (error) {
                    console.error(`Error ${action}ing verification request:`, error);
                    showError(`Failed to ${action} verification request: ${error.message}`);
                } finally {
                    approveBtn.disabled = false;
                    rejectBtn.disabled = false;
                }
            }
            
            // Helper functions
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                
                try {
                    const date = new Date(dateString);
                    return new Intl.DateTimeFormat('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).format(date);
                } catch (e) {
                    return dateString;
                }
            }
            
            function formatProfessionalType(type) {
                if (!type) return 'Unknown';
                
                return type
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }
            
            function showError(message) {
                // You can replace this with a nicer toast notification if available
                alert('Error: ' + message);
            }
        });
    </script>
</body>
</html>