<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="auth-token" content="<%= locals.token || '' %>">
    <title><%= locals.conversation ? (conversation.businessContext ? conversation.businessContext.name : conversation.recipient.name) : 'New Conversation' %> | Arzani Marketplace</title>
    
    <!-- Core Stylesheets -->
    <link rel="stylesheet" href="/css/modern.css">
    <link rel="stylesheet" href="/css/chat-interface.css">
    
    <!-- Third-party Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    
    <!-- Utility Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#4682B4',
                            DEFAULT: '#2E5984',
                            dark: '#1E3A57'
                        },
                        secondary: {
                            light: '#F4F7FA',
                            DEFAULT: '#E2E8F0',
                            dark: '#CBD5E1'
                        },
                        success: '#38A169',
                        danger: '#E53E3E',
                        warning: '#ED8936',
                        info: '#4299E1'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <!-- Add user data for debugging -->
    <link rel="stylesheet" href="/css/chat-enhanced.css">

    <!-- Add this in the <head> section, inside the <style> tag or append to existing styles -->
    <style>
      /* Formatted message styles */
      .formatted-message {
        width: 100%;
      }
      
      .message-heading {
        color: #064fa3;
        display: block;
        margin-top: 8px;
        margin-bottom: 2px;
        font-weight: 600;
      }
      
      .system-message {
        background-color: rgba(227, 242, 253, 0.7) !important;
        color: #333 !important;
        font-style: italic;
        text-align: center;
        max-width: 80% !important;
        margin: 10px auto;
        border-left: none !important;
        border-radius: 8px !important;
      }
      
      /* Welcome notification */
      .welcome-notification {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 12px 16px;
        margin: 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #2e7d32;
        text-align: center;
        position: relative;
        animation: fadeIn 0.5s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .welcome-notification .close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: none;
        border: none;
        color: #2e7d32;
        cursor: pointer;
        font-size: 16px;
      }
    </style>
</head>
<body class="bg-secondary-light font-sans h-screen overflow-hidden flex flex-col">
    <!-- Header with conversation info -->
    <header class="bg-white shadow-sm py-3 px-4 flex items-center justify-between sticky top-0 z-10">
        <div class="flex items-center">
            <a href="/chat" class="mr-4 text-gray-600 hover:text-primary transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            
            <% if (locals.conversation && conversation.participant) { %>
                <div class="flex items-center">
                    <div class="relative mr-3">
                        <img src="<%= conversation.participant.profilePicture || '/images/default-profile.png' %>" 
                             alt="<%= conversation.participant.name %>" 
                             class="w-10 h-10 rounded-full object-cover">
                        <span class="status-indicator <%= conversation.participant.isOnline ? 'online' : 'offline' %> absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white"></span>
                    </div>
                    <div>
                        <h1 class="font-semibold text-gray-900"><%= conversation.participant.name %></h1>
                        <div class="text-xs text-gray-500">
                            <%= conversation.participant.isOnline ? 'Online now' : `Last seen ${formatRelativeTime(conversation.participant.lastActive)}` %>
                        </div>
                    </div>
                </div>
            <% } else { %>
                <h1 class="font-semibold text-gray-900">New Conversation</h1>
            <% } %>
        </div>
        
        <div class="flex items-center space-x-2">
            <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500" id="searchBtn" title="Search in conversation">
                <i class="fas fa-search"></i>
            </button>
            <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500" id="callBtn" title="Call">
                <i class="fas fa-phone"></i>
            </button>
            <div class="relative">
                <button class="p-2 rounded-full hover:bg-gray-100 text-gray-500" id="moreBtn" title="More options">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden" id="moreMenu">
                    <button class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">View profile</button>
                    <button class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">Mute notifications</button>
                    <button class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100" id="exportChat">Export chat</button>
                    <div class="border-t my-1"></div>
                    <button class="block w-full text-left px-4 py-2 text-red-600 hover:bg-gray-100">Block user</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Business context panel (shown when conversation is related to a business) -->
    <% if (locals.conversation && conversation.businessContext) { %>
    <div id="businessContextPanel" class="business-context-panel bg-white border-b border-gray-200 px-4 py-3">
        <div class="business-context-content flex justify-between items-center">
            <div class="business-info">
                <h3 class="text-lg font-medium text-gray-900">
                    <a href="/businesses/<%= conversation.businessContext.id %>" target="_blank" class="hover:text-primary hover:underline transition-colors">
                        <%= conversation.businessContext.name %>
                    </a>
                </h3>
                <div class="business-meta text-sm text-gray-600 flex items-center flex-wrap gap-x-2">
                    <span class="business-price font-medium">¬£<%= Number(conversation.businessContext.price).toLocaleString() %></span>
                    <span class="business-divider">‚Ä¢</span>
                    <span class="business-industry"><%= conversation.businessContext.industry %></span>
                    <span class="business-divider">‚Ä¢</span>
                    <span class="business-location"><%= conversation.businessContext.location %></span>
                </div>
                <% if (conversation.inquiry) { %>
                <div class="inquiry-info mt-1 text-xs text-gray-500">
                    <span>Inquiry made <%= new Date(conversation.inquiry.created_at).toLocaleDateString() %></span>
                    <span class="ml-2">Timeline: <%= conversation.inquiry.timeframe || 'Not specified' %></span>
                </div>
                <% } %>
            </div>
            <div class="context-actions flex items-center">
                <button class="view-listing-btn bg-primary text-white px-3 py-1.5 rounded text-sm hover:bg-primary-dark transition-colors mr-2" onclick="window.open('/businesses/<%= conversation.businessContext.id %>', '_blank')">
                    <i class="fas fa-external-link-alt mr-1"></i> View Listing
                </button>
                <button class="minimize-context-btn p-1.5 rounded-full hover:bg-gray-100 text-gray-500" onclick="toggleBusinessContext()">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
    </div>
    <% } %>

    <!-- Main chat area -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Messages container -->
        <div class="chat-messages flex-1 overflow-y-auto p-4 space-y-4" id="chatMessages">
            <% if (locals.messages && messages.length > 0) { %>
                <% 
                let currentDate = null;
                messages.forEach((message, index) => {
                    // Group by date
                    const messageDate = new Date(message.created_at);
                    const messageDateStr = messageDate.toDateString();
                    
                    if (currentDate !== messageDateStr) {
                        currentDate = messageDateStr;
                %>
                    <div class="message-date-separator flex items-center justify-center my-4">
                        <span class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full">
                            <%= formatMessageDate(messageDate) %>
                        </span>
                    </div>
                <% } %>
                
                <div class="message <%= message.sender_id === userId ? 'outgoing' : '' %>" data-message-id="<%= message.id %>">
                    <div class="flex <%= message.sender_id === userId ? 'justify-end' : '' %>">
                        <% if (message.sender_id !== userId) { %>
                        <div class="message-avatar mr-2">
                            <img src="<%= message.sender_profile_pic || '/images/default-profile.png' %>" 
                                 alt="<%= message.sender_name %>" 
                                 class="w-8 h-8 rounded-full">
                        </div>
                        <% } %>
                        
                        <div class="message-bubble max-w-[75%] p-3 rounded-lg <%= message.sender_id === userId ? 'bg-primary text-white' : 'bg-white border border-gray-200' %>">
                            <% if (message.is_system_message) { %>
                                <div class="system-message text-gray-500 italic">
                                    <%= message.content %>
                                </div>
                            <% } else { %>
                                <div class="message-content">
                                    <%= message.content %>
                                </div>
                            <% } %>
                            
                            <div class="message-meta flex items-center justify-end mt-1 text-xs <%= message.sender_id === userId ? 'text-blue-100' : 'text-gray-500' %>">
                                <span class="message-time">
                                    <%= new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                </span>
                                
                                <% if (message.sender_id === userId) { %>
                                    <span class="message-status ml-1 <%= message.is_read ? 'seen' : '' %>">
                                        <i class="fas fa-check<%= message.is_read ? '-double' : '' %>"></i>
                                    </span>
                                <% } %>
                            </div>
                            
                            <% if (message.reactions && message.reactions.length > 0) { %>
                            <div class="message-reactions mt-1 flex -ml-1">
                                <% message.reactions.forEach(reaction => { %>
                                    <span class="reaction px-1.5 py-0.5 bg-gray-100 rounded-full text-xs mr-1" 
                                          title="<%= reaction.username %>">
                                        <%= reaction.reaction %>
                                    </span>
                                <% }); %>
                            </div>
                            <% } %>
                        </div>
                        
                        <% if (message.sender_id === userId) { %>
                        <div class="message-avatar ml-2">
                            <img src="<%= locals.user?.profile_picture || '/images/default-profile.png' %>" 
                                 alt="You" 
                                 class="w-8 h-8 rounded-full">
                        </div>
                        <% } %>
                    </div>
                </div>
            <% }); %>
            <% } else { %>
                <div class="empty-state flex flex-col items-center justify-center h-full text-center py-12">
                    <div class="icon-container bg-gray-100 w-20 h-20 flex items-center justify-center rounded-full mb-4">
                        <i class="far fa-comments text-3xl text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Start a conversation</h3>
                    <p class="text-gray-600 max-w-md mb-6">
                        <% if (locals.conversation && conversation.businessContext) { %>
                            Ask questions about <%= conversation.businessContext.name %> or discuss your interest in this business opportunity.
                        <% } else { %>
                            Send a message to start chatting. Your conversations are private and secure.
                        <% } %>
                    </p>
                    
                    <!-- Suggested messages -->
                    <div class="suggested-messages w-full max-w-md">
                        <div class="grid grid-cols-1 gap-2">
                            <button class="suggested-message text-left bg-white border border-gray-200 rounded-lg px-4 py-3 hover:bg-gray-50 transition-colors"
                                    onclick="insertSuggestedMessage(this)">
                                üëã Hi, I'm interested in learning more about this business opportunity.
                            </button>
                            <button class="suggested-message text-left bg-white border border-gray-200 rounded-lg px-4 py-3 hover:bg-gray-50 transition-colors"
                                    onclick="insertSuggestedMessage(this)">
                                ü§î Could you tell me more about the financials and growth potential?
                            </button>
                            <button class="suggested-message text-left bg-white border border-gray-200 rounded-lg px-4 py-3 hover:bg-gray-50 transition-colors"
                                    onclick="insertSuggestedMessage(this)">
                                üìÖ I'd like to schedule a meeting to discuss this opportunity further.
                            </button>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <!-- Typing indicator (shown when someone is typing) -->
            <div id="typingIndicator" class="typing-indicator hidden">
                <div class="flex items-end">
                    <div class="message-avatar mr-2">
                        <img src="/images/default-profile.png" alt="User typing" class="w-8 h-8 rounded-full">
                    </div>
                    <div class="typing-bubble bg-white border border-gray-200 rounded-full px-4 py-2">
                        <div class="typing-dots flex space-x-1">
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message input area -->
        <div class="message-input-container bg-white border-t border-gray-200 p-3">
            <div class="flex items-end">
                <div class="attachments-area flex space-x-1 mr-2">
                    <button class="input-action-btn p-2 rounded-full hover:bg-gray-100 text-gray-500" id="attachBtn" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-action-btn p-2 rounded-full hover:bg-gray-100 text-gray-500" id="emojiBtn" title="Add emoji">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                
                <div class="flex-1 bg-gray-50 rounded-2xl px-4 py-2 border border-gray-200 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary">
                    <div id="editor-container" class="chat-input-editor min-h-[40px] max-h-[120px] overflow-y-auto"></div>
                </div>
                
                <button id="sendMessageBtn" class="ml-2 p-3 bg-primary text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- Upload progress indicator (hidden by default) -->
            <div id="uploadProgress" class="hidden mt-2 bg-gray-100 rounded-full overflow-hidden">
                <div class="progress-bar bg-primary h-1 w-0 transition-all duration-300"></div>
            </div>
        </div>
    </main>

    <!-- Emoji picker (hidden by default) -->
    <div id="emojiPicker" class="emoji-picker hidden fixed bottom-20 left-0 p-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20">
        <div class="emoji-picker-tabs border-b border-gray-200 pb-2 mb-2 flex space-x-2">
            <button class="emoji-tab-btn active p-1.5 rounded" data-tab="recent">üïí</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="smileys">üòÄ</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="people">üëã</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="nature">üåø</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="food">üçî</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="activities">‚öΩ</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="objects">üí°</button>
            <button class="emoji-tab-btn p-1.5 rounded" data-tab="symbols">‚ù§Ô∏è</button>
        </div>
        <div class="emoji-grid grid grid-cols-8 gap-1"></div>
    </div>

    <!-- File upload input (hidden) -->
    <input type="file" id="fileInput" class="hidden" multiple />

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="/js/chat-ws-client.js"></script>
    <script src="/js/chat.js"></script>
    <script src="/js/chat-interface.js"></script>
    <script src="/js/chat-activity-tracker.js"></script>
    <script>
        // Initialize Quill editor
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: false
            },
            placeholder: 'Type a message...'
        });
        
        // Initialize business context panel toggle
        function toggleBusinessContext() {
            const panel = document.getElementById('businessContextPanel');
            if (panel) {
                panel.classList.toggle('minimized');
                const icon = panel.querySelector('.minimize-context-btn i');
                icon.className = panel.classList.contains('minimized') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            }
        }
        
        // Initialize more options menu toggle
        document.getElementById('moreBtn').addEventListener('click', function() {
            document.getElementById('moreMenu').classList.toggle('hidden');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#moreBtn') && !e.target.closest('#moreMenu')) {
                document.getElementById('moreMenu').classList.add('hidden');
            }
        });
        
        // Insert suggested message into editor
        function insertSuggestedMessage(button) {
            quill.setText(button.innerText);
            document.getElementById('sendMessageBtn').disabled = false;
            quill.focus();
        }
        
        // Format message date
        function formatMessageDate(date) {
            const now = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === now.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            }
        }
        
        // Format relative time
        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'a while ago';
            
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000);
            
            if (diffMin < 1) return 'just now';
            if (diffMin < 60) return `${diffMin}m ago`;
            
            const diffHour = Math.floor(diffMin / 60);
            if (diffHour < 24) return `${diffHour}h ago`;
            
            const diffDay = Math.floor(diffHour / 24);
            if (diffDay < 7) return `${diffDay}d ago`;
            
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }
    </script>
</body>
</html>