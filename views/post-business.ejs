<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post a Business</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
    <link rel="stylesheet" href="/css/post-business.css">
    <link rel="stylesheet" href="/css/valuation.css">
    
    <!-- Only load Google Maps API if key is available -->
    <% if (locals.hasGoogleMapsKey && locals.googleMapsApiKey) { %>
        <script>
            // Track API loading state
            window.mapsApiState = {
                loading: true,
                initialized: false,
                error: null
            };
            
            function initMap() {
                console.log('Google Maps API initialized successfully');
                window.mapsApiState.initialized = true;
                window.mapsApiState.loading = false;
                
                // This function will be called when Google Maps loads successfully
                window.googleMapsLoaded = true;
                
                try {
                    // Initialize location autocomplete if input exists
                    const locationInput = document.getElementById('location');
                    if (locationInput && google && google.maps && google.maps.places) {
                        console.log('Setting up location autocomplete');
                        const autocomplete = new google.maps.places.Autocomplete(locationInput, {
                            types: ['(cities)'],
                            componentRestrictions: { country: 'gb' }
                        });

                        autocomplete.addListener('place_changed', function() {
                            const place = autocomplete.getPlace();
                            console.log('Place selected:', place.formatted_address);
                        });
                    } else {
                        console.warn('Location input or Places API not available');
                    }
                } catch (err) {
                    console.error('Error initializing Places autocomplete:', err);
                    enableManualLocationEntry();
                }
            }
            
            function gm_authFailure() {
                console.error('Google Maps authentication failed');
                window.mapsApiState.error = 'auth_failure';
                window.mapsApiState.loading = false;
                document.getElementById('maps-error').textContent = 
                    'Google Maps API authentication failed. You can still enter location manually.';
                document.getElementById('maps-error').style.display = 'block';
                enableManualLocationEntry();
            }
            
            function handleGoogleMapsError() {
                console.error('Google Maps API failed to load');
                window.mapsApiState.error = 'load_failure';
                window.mapsApiState.loading = false;
                document.getElementById('maps-error').textContent = 
                    'Google Maps location services are currently unavailable. You can still enter your location manually.';
                document.getElementById('maps-error').style.display = 'block';
                enableManualLocationEntry();
            }
            
            function enableManualLocationEntry() {
                const locationInput = document.getElementById('location');
                if (locationInput) {
                    locationInput.setAttribute('placeholder', 'Enter location manually (e.g., London, UK)');
                    locationInput.removeAttribute('readonly');
                    // Optional: Add a class to style the input differently
                    locationInput.classList.add('manual-entry');
                }
            }
            
            // Add a timeout to detect if the API takes too long to load
            setTimeout(function() {
                if (window.mapsApiState.loading && !window.mapsApiState.initialized) {
                    console.warn('Google Maps API taking too long to load, enabling manual entry');
                    handleGoogleMapsError();
                }
            }, 5000);
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=places&callback=initMap" 
                async defer onerror="handleGoogleMapsError()"></script>
    <% } else { %>
        <script>
            console.warn('Google Maps API key not available');
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('maps-error').textContent = 'Google Maps API key not configured.';
                document.getElementById('maps-error').style.display = 'block';
                
                // Enable manual location entry
                const locationInput = document.getElementById('location');
                if (locationInput) {
                    locationInput.setAttribute('placeholder', 'Enter location manually (e.g., London, UK)');
                    locationInput.removeAttribute('readonly');
                }
            });
        </script>
    <% } %>
    
    <script>
        // Store user info and token in localStorage
        const authInfo = {
            userId: "<%= user?.userId %>",
            token: "<%= token %>"
        };
        
        console.log("Auth info on page load:", {
            userId: authInfo.userId,
            hasToken: !!authInfo.token
        });
        
        // Make token available to JavaScript and store in localStorage
        if (authInfo.token) {
            window.authToken = authInfo.token;
            localStorage.setItem('token', authInfo.token);
            console.log("Auth token stored in localStorage");
        } else {
            console.warn("No auth token provided to the template");
            // Try to get from localStorage if not in template
            const storedToken = localStorage.getItem('token');
            if (storedToken) {
                window.authToken = storedToken;
                console.log("Using token from localStorage");
            }
        }
        
        // Add auth debugging info
        window.addEventListener('DOMContentLoaded', () => {
            fetch('/api/token-debug')
                .then(response => response.json())
                .then(data => {
                    console.log('Token debug info:', data);
                    
                    // Update token if needed
                    if (data.authHeader.status === 'valid' && !window.authToken) {
                        window.authToken = data.authHeader.token;
                        localStorage.setItem('token', data.authHeader.token);
                        console.log("Updated token from debug endpoint");
                    }
                })
                .catch(error => console.error('Token debug error:', error));
        });
    </script>
</head>
<body>


    <div id="maps-error" style="display:none" class="alert alert-warning mt-2">
        <strong>Note:</strong> Google Maps location services are currently unavailable. You can still enter your location manually.
      </div>
   


    <!-- Store auth token in hidden input for JavaScript access -->
    <input type="hidden" id="auth-token" value="<%= token %>">
    
    <a href="/marketplace2" class="back-to-marketplace">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Marketplace
    </a>
    <div class="container mt-5">
        <h1>Post a Business</h1>
        <div class="alert alert-info">
            <strong>Important:</strong> To ensure quality listings, please fill out at least 8 of the following fields:
            <ul>
                <li>Business Name (Required)</li>
                <li>Industry (Required)</li>
                <li>Price (Required)</li>
                <li>Description (Required)</li>
                <li>Location</li>
                <li>Gross Revenue</li>
                <li>Number of Employees</li>
                <li>Years in Operation</li>
                <li>Cash Flow</li>
                <li>Reason for Selling</li>
            </ul>
        </div>
        <form id="postBusinessForm" class="needs-validation" novalidate method="POST" action="/api/submit-business" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="title" class="form-label">Business Name</label>
                <input type="text" class="form-control" id="title" name="business_name" required>
                <div class="invalid-feedback">Please provide the name of your business.</div>
            </div>
            <div class="mb-3">
                <label for="industry">Industry</label>
                <select id="industry" name="industry">
                    <option value="Agriculture">Agriculture</option>
                    <option value="Automotive &amp; Boat">Automotive &amp; Boat</option>
                    <option value="Beauty &amp; Personal Care">Beauty &amp; Personal Care</option>
                    <option value="Building &amp; Construction">Building &amp; Construction</option>
                    <option value="Communication &amp; Media">Communication &amp; Media</option>
                    <option value="Education &amp; Children">Education &amp; Children</option>
                    <option value="Entertainment &amp; Recreation">Entertainment &amp; Recreation</option>
                    <option value="Financial Services">Financial Services</option>
                    <option value="Health Care &amp; Fitness">Health Care &amp; Fitness</option>
                    <option value="Manufacturing">Manufacturing</option>
                    <option value="Online &amp; Technology">Online &amp; Technology</option>
                    <option value="Pet Services">Pet Services</option>
                    <option value="Restaurants &amp; Food">Restaurants &amp; Food</option>
                    <option value="Retail">Retail</option>
                    <option value="Service Businesses">Service Businesses</option>
                    <option value="Transportation &amp; Storage">Transportation &amp; Storage</option>
                    <option value="Travel">Travel</option>
                    <option value="Wholesale &amp; Distributors">Wholesale & Distributors</option>
                    <option value="Other">Other</option>
                    <!-- Add more industries as needed -->
                </select>
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Asking Price (£)</label>
                <input type="number" class="form-control" id="price" name="price" required>
                <div class="invalid-feedback">Please provide a price.</div>
            </div>
            <div class="mb-3">
                <label for="cash_flow" class="form-label">Net Cash Flow (£/Year)</label>
                <input type="number" class="form-control" id="cash_flow" name="cash_flow">
            </div>
            <div class="mb-3">
                <label for="gross_revenue" class="form-label">Gross Revenue (£/Year)</label>
                <input type="number" class="form-control" id="gross_revenue" name="gross_revenue">
            </div>
            <div class="mb-3">
                <label for="ebitda" class="form-label">EBITDA (£/Year)</label>
                <input type="number" class="form-control" id="ebitda" name="ebitda">
            </div>
            <div class="mb-3">
                <label for="inventory" class="form-label">Inventory Value (£)</label>
                <input type="number" class="form-control" id="inventory" name="inventory">
            </div>
            <div class="mb-3">
                <label for="sales_multiple" class="form-label">Sales Multiple (×)</label>
                <input type="text" class="form-control" id="sales_multiple" name="sales_multiple">
            </div>
            <div class="mb-3">
                <label for="profit_margin" class="form-label">Profit Margin (%)</label>
                <input type="text" class="form-control" id="profit_margin" name="profit_margin">
            </div>
            <div class="mb-3">
                <label for="debt_service" class="form-label">Annual Debt Service (£)</label>
                <input type="number" class="form-control" id="debt_service" name="debt_service">
            </div>
            <div class="mb-3">
                <label for="cash_on_cash" class="form-label">Cash-on-Cash Return (%)</label>
                <input type="text" class="form-control" id="cash_on_cash" name="cash_on_cash">
            </div>
            <div class="mb-3">
                <label for="down_payment" class="form-label">Down Payment (£)</label>
                <input type="number" class="form-control" id="down_payment" name="down_payment">
            </div>
            <div class="mb-3">
                <label for="location" class="form-label">Business Location</label>
                <input type="text" class="form-control" id="location" name="location">
            </div>
            <div class="mb-3">
                <label for="ffE" class="form-label">FF&E Value (£)</label>
                <input type="text" class="form-control" id="ffE" name="ffE">
            </div>
            <div class="mb-3">
                <label for="employees" class="form-label">Number of Employees</label>
                <input type="number" class="form-control" id="employees" name="employees">
            </div>
            <div class="mb-3">
                <label for="reasonForSelling" class="form-label">Reason for Selling</label>
                <textarea class="form-control" id="reasonForSelling" name="reasonForSelling" rows="2"></textarea>
            </div>

            <div class="mb-3">
                <label for="yearsInOperation" class="form-label">Years in Operation</label>
                <input type="number" class="form-control" id="yearsInOperation" name="yearsInOperation">
            </div>

            <div class="mb-3">
                <label for="recurringRevenue" class="form-label">Recurring Revenue (%)</label>
                <input type="number" class="form-control" id="recurringRevenue" name="recurringRevenue" min="0" max="100" step="0.01">
            </div>

            <div class="mb-3">
                <label for="growthRate" class="form-label">Annual Growth Rate (%)</label>
                <input type="number" class="form-control" id="growthRate" name="growthRate" min="-100" max="1000" step="0.01">
            </div>

            <div class="mb-3">
                <label for="intellectualProperty" class="form-label">Intellectual Property Assets</label>
                <input type="text" class="form-control" id="intellectualProperty" name="intellectualProperty" 
                       placeholder="Separate multiple items with commas">
            </div>

            <div class="mb-3">
                <label for="websiteTraffic" class="form-label">Monthly Website Traffic (Visits)</label>
                <input type="number" class="form-control" id="websiteTraffic" name="websiteTraffic">
            </div>

            <div class="mb-3">
                <label for="socialFollowers" class="form-label">Total Social Media Followers</label>
                <input type="number" class="form-control" id="socialFollowers" name="socialFollowers">
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                <div class="invalid-feedback">Please provide a description.</div>
            </div>  
            <div class="mb-3">
                <label for="images" class="form-label">Upload Images</label>
                <div class="dropzone" id="imageDropzone"></div>
                <div class="image-requirement-notice">
                    * You must upload between 3-5 images of your business
                </div>
            </div>
            
            <div class="business-valuation-container">
                <div class="valuation-status hidden">
                    <div class="valuation-header">
                        <h3>Business Valuation Analysis</h3>
                        <div class="confidence-meter">
                            <span class="confidence-label">Confidence:</span>
                            <div class="confidence-value">0%</</div>
                        </div>
                    </div>
                    <div class="valuation-details"></div>
                </div>
            </div>

            <!-- New Advanced Valuation Section -->
            <div class="advanced-valuation-container hidden">
                <h3>Advanced Business Valuation Analysis</h3>
                <div class="advanced-valuation-details"></div>
            </div>

            <!-- New button to trigger advanced valuation -->
            <button type="button" id="checkAdvancedValuation" class="btn btn-secondary mb-3">
                Check Advanced Valuation
            </button>
            
            <button type="button" id="checkValuation" class="btn btn-secondary mb-3">
                Check Market Valuation
            </button>
            
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/post-business.js"></script>
    <script>
        // Add additional auth check on page load
        document.addEventListener('DOMContentLoaded', () => {
            // If no auth token is available, redirect to login
            if (!window.authToken && !localStorage.getItem('token')) {
                console.error('No authentication token available, redirecting to login');
                window.location.href = '/login2?returnTo=' + encodeURIComponent('/post-business');
            }
        });
    </script>
</body>
</html>