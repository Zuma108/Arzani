<!-- Modern Glassmorphism Sidebar Component -->
<!-- Mobile menu button -->
<button id="mobile-sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-50 p-3 rounded-xl glass-surface shadow-lg transition-all duration-200">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-amber-800">
        <path d="M3 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- Sidebar Overlay for Mobile -->
<div id="sidebar-overlay" class="lg:hidden fixed inset-0 z-40 bg-black bg-opacity-50 hidden transition-opacity duration-300"></div>

<!-- Main Sidebar -->
<aside id="unified-sidebar" class="fixed inset-y-0 left-0 z-40 transition-all duration-300 ease-in-out sidebar-container">
    
    <!-- Desktop Toggle Button - Inside Sidebar, Positioned at Right Edge -->
    <button id="desktop-sidebar-toggle" class="hidden lg:flex absolute p-2 glass-toggle-button" style="top: 30px; right: -20px; z-index: 1001;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="toggle-arrow transition-transform duration-300 ease-in-out" style="color: #041b76;">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    
    <div class="flex flex-col h-full glass-sidebar">
        <!-- Header Section with Profile -->
        <div class="flex items-center justify-between px-6 py-6" style="border-bottom: 0.5px solid rgba(67, 44, 44, 0.24);">
            <!-- Profile Section -->
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <img src="<%= locals.user && locals.user.profile_picture ? locals.user.profile_picture : '/images/default-profile.png' %>" 
                         alt="User Avatar" 
                         class="h-12 w-12 rounded-full object-cover"
                         style="background: #f2baba;">
                    <!-- Status indicator -->
                    <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full" style="background: #4ade80;"></div>
                </div>
                <div class="sidebar-text">
                    <div class="text-xs font-medium uppercase tracking-wider opacity-60" style="color: rgba(36, 34, 32, 0.4);">
                        <%= locals.user && locals.user.is_verified_professional ? 'Verified Professional' : 'Member' %>
                    </div>
                    <div class="text-sm font-semibold" style="color: #242220;">
                        <%= locals.user && locals.user.username ? locals.user.username.split(' ')[0] : 'User' %>
                    </div>
                    <!-- Token counter removed by user request - functionality preserved -->
                </div>
            </div>
        </div>

        <!-- Navigation Section -->
        <nav class="flex-1 px-6 py-6 space-y-2 overflow-y-auto">
            <!-- Main Navigation Section -->
            <div class="space-y-1">
                <div class="sidebar-text px-3 pb-2 text-xs font-medium uppercase tracking-wider opacity-60" style="color: rgba(36, 34, 32, 0.4);">Main</div>
                
                <!-- Dashboard with Active State and Glow -->
                <div class="relative">
                    <a href="/marketplace2" 
                       class="nav-item active flex items-center glass-nav-item glass-nav-item--active group relative overflow-hidden"
                       data-page="marketplace"
                       data-tooltip="Marketplace">
                        <div class="flex items-center justify-center w-6 h-6 mr-4 relative z-10">
                            <img src="/figma design exports/icons/05-dashboard.svg" alt="Dashboard" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                        </div>
                        <span class="sidebar-text font-medium relative z-10" style="color: #242220;">Marketplace</span>
                        <div class="ml-auto relative z-10">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-transform duration-200" style="color: rgba(36, 34, 32, 0.4);">
                                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </a>
                    
                    <!-- Dashboard Submenu -->
                    <div class="dashboard-submenu mt-2 ml-6 space-y-1" style="opacity: 1;">
                        <div class="relative">
                            <!-- Connection line -->
                            <div class="absolute left-0 top-0 bottom-0 w-3.5" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTEwIiB2aWV3Qm94PSIwIDAgMTQgMTEwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNNyAwVjI4SDE0VjM1SDdWMTEwIiBzdHJva2U9InJnYmEoMzYsIDM0LCAzMiwgMC4yKSIgc3Ryb2tlLXdpZHRoPSIwLjUiLz4KPC9zdmc+');"></div>
                            <div class="space-y-1 pl-8">
                                <a href="#" class="block px-4 py-2 text-sm rounded-lg transition-colors duration-200" style="color: rgba(36, 34, 32, 0.56);">Activity</a>
                                <a href="#" class="block px-4 py-2 text-sm rounded-lg transition-colors duration-200" style="color: rgba(36, 34, 32, 0.56);">Traffic</a>
                                <a href="#" class="block px-4 py-2 text-sm rounded-lg transition-colors duration-200 active-subitem" style="color: #242220; background: rgba(36, 34, 32, 0.04);">Statistics</a>
                            </div>
                        </div>
                    </div>
                </div>

                <a href="/market-trends" 
                   class="nav-item flex items-center glass-nav-item group"
                   data-page="market-trends"
                   data-tooltip="Market Trends"
                   style="color: rgba(36, 34, 32, 0.56);">
                    <div class="flex items-center justify-center w-6 h-6 mr-4">
                        <img src="/figma design exports/icons/06-chart.svg" alt="Market Trends" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                    </div>
                    <span class="sidebar-text font-medium transition-opacity duration-200">Market Trends</span>
                </a>

                <a href="/chat" 
                   class="nav-item flex items-center glass-nav-item group"
                   data-page="conversations"
                   data-tooltip="Conversations"
                   style="color: rgba(36, 34, 32, 0.56);">
                    <div class="flex items-center justify-center w-6 h-6 mr-4">
                        <img src="/figma design exports/icons/07-messages.svg" alt="Conversations" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                    </div>
                    <span class="sidebar-text font-medium transition-opacity duration-200">Conversations</span>
                    <div class="ml-auto">
                        <span id="conversations-badge" class="hidden bg-red-500 text-white text-xs rounded-full px-2 py-0.5 animate-pulse">3</span>
                    </div>
                </a>

                <!-- Verification Tab - Different for Admin vs Regular Users -->
                <% if (locals.user && locals.user.role === 'admin') { %>
                    <!-- Admin: Review Verifications -->
                    <a href="/admin/verification-review" 
                       class="nav-item flex items-center glass-nav-item group"
                       data-page="admin-verification-review"
                       data-tooltip="Review Professional Verifications"
                       style="color: rgba(36, 34, 32, 0.56);">
                        <div class="flex items-center justify-center w-6 h-6 mr-4">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                                <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <span class="sidebar-text font-medium transition-opacity duration-200">Review Verifications</span>
                    </a>
                <% } else { %>
                    <!-- Regular Users: Professional Verification -->
                    <a href="/professional-verification" 
                       class="nav-item flex items-center glass-nav-item group"
                       data-page="professional-verification"
                       data-tooltip="Verification"
                       style="color: rgba(36, 34, 32, 0.56);">
                        <div class="flex items-center justify-center w-6 h-6 mr-4">
                            <img src="/figma design exports/icons/08-verification.svg" alt="Verification" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                        </div>
                        <span class="sidebar-text font-medium transition-opacity duration-200">Verification</span>
                    </a>
                <% } %>

                <!-- Stripe Connect Payment Dashboard for Verified Professionals Only -->
                <% if (locals.user && locals.user.is_verified_professional) { %>
                <a href="/stripe-connect/dashboard" 
                   class="nav-item flex items-center glass-nav-item group"
                   data-page="payment-dashboard"
                   data-tooltip="Payment Dashboard"
                   style="color: rgba(36, 34, 32, 0.56);">
                    <div class="flex items-center justify-center w-6 h-6 mr-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110" style="color: rgba(36, 34, 32, 0.56);">
                            <rect x="1" y="4" width="22" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                            <line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <span class="sidebar-text font-medium transition-opacity duration-200">Payment Dashboard</span>
                </a>
                <% } %>

                <a href="/profile" 
                   class="nav-item flex items-center glass-nav-item group"
                   data-page="profile"
                   data-tooltip="Profile"
                   style="color: rgba(36, 34, 32, 0.56);">
                    <div class="flex items-center justify-center w-6 h-6 mr-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110" style="color: rgba(36, 34, 32, 0.56);">
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span class="sidebar-text font-medium transition-opacity duration-200">Profile</span>
                </a>
            </div>



            <!-- Divider -->
            <div class="my-6" style="height: 0.5px; background: radial-gradient(ellipse 50% 50% at 50% 50%, rgba(67, 44, 44, 1) 0%, rgba(80, 28, 28, 0) 100%); opacity: 0.24;"></div>

            <!-- Conversations Section -->
            <div class="space-y-1">
                <div class="flex items-center justify-between px-3 pb-2">
                    <div class="sidebar-text text-xs font-medium uppercase tracking-wider opacity-60" style="color: rgba(36, 34, 32, 0.4);">Conversations</div>
                    <button class="p-1 rounded-lg hover:opacity-80 transition-opacity duration-200" onclick="window.location.href='/chat'">
                        <img src="/figma design exports/icons/12-plus.svg" alt="Add" class="w-4 h-4">
                    </button>
                </div>
                
                <!-- Dynamic Recent Conversations -->
                <div id="sidebar-conversations" class="space-y-1">
                    <% if (locals.conversations && locals.conversations.length > 0) { %>
                        <% locals.conversations.slice(0, 5).forEach(function(conversation) { %>
                            <div class="flex items-center px-5 py-3 rounded-xl hover:bg-black hover:bg-opacity-5 transition-all duration-200 cursor-pointer group <%= conversation.unread_count > 0 ? 'has-unread' : '' %>"
                                 onclick="window.location.href='/chat?conversation=<%= conversation.id %>'">
                                <div class="relative mr-4">
                                    <% if (conversation.recipient && conversation.recipient.profile_picture) { %>
                                        <img src="<%= conversation.recipient.profile_picture %>" 
                                             alt="<%= conversation.recipient.username || 'User' %>" 
                                             class="w-6 h-6 rounded-full object-cover"
                                             onerror="this.src='/images/default-profile.png'; this.onerror=null;">
                                    <% } else if (conversation.recipient && conversation.recipient.professional_picture_url) { %>
                                        <img src="<%= conversation.recipient.professional_picture_url %>" 
                                             alt="<%= conversation.recipient.username || 'User' %>" 
                                             class="w-6 h-6 rounded-full object-cover"
                                             onerror="this.src='/images/default-profile.png'; this.onerror=null;">
                                    <% } else if (conversation.is_ai_chat) { %>
                                        <div class="w-6 h-6 rounded-full overflow-hidden flex items-center justify-center" style="background: linear-gradient(135deg, #041b76, #064fa3);">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M9.5 2A1.5 1.5 0 0 0 8 3.5V8l-2.4-1.6A1.5 1.5 0 0 0 3.5 8.4l1.6 2.4H1.5A1.5 1.5 0 0 0 0 12.5A1.5 1.5 0 0 0 1.5 14h3.6l-1.6 2.4A1.5 1.5 0 0 0 5.6 18.4L8 16.8v4.5A1.5 1.5 0 0 0 9.5 22A1.5 1.5 0 0 0 11 20.5V16l2.4 1.6a1.5 1.5 0 0 0 2.1-2.1L13.9 13l1.6-2.4a1.5 1.5 0 0 0-2.1-2.1L11 10V5.5A1.5 1.5 0 0 0 9.5 4z" fill="white"/>
                                            </svg>
                                        </div>
                                    <% } else { %>
                                        <div class="w-6 h-6 rounded-full overflow-hidden flex items-center justify-center" style="background: #f2baba;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="#8B5A3C" stroke-width="2"/>
                                                <circle cx="12" cy="7" r="4" stroke="#8B5A3C" stroke-width="2"/>
                                            </svg>
                                        </div>
                                    <% } %>
                                    
                                    <!-- Online/Activity status -->
                                    <% if (conversation.recipient && conversation.recipient.last_active) { %>
                                        <% 
                                            const lastActive = new Date(conversation.recipient.last_active);
                                            const now = new Date();
                                            const isOnline = (now - lastActive) < 5 * 60 * 1000; // 5 minutes
                                        %>
                                        <div class="absolute bottom-0 right-0 w-1.5 h-1.5 rounded-full" 
                                             style="background: <%= isOnline ? '#4ade80' : 'rgba(36, 34, 32, 0.4)' %>; <%= !isOnline ? 'border: 1px solid #666260;' : '' %>"></div>
                                    <% } else { %>
                                        <div class="absolute bottom-0 right-0 w-1.5 h-1.5 rounded-full border border-gray-600" style="background: rgba(36, 34, 32, 0.4);"></div>
                                    <% } %>
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <span class="sidebar-text text-sm font-medium block truncate" style="color: <%= conversation.unread_count > 0 ? '#242220' : 'rgba(36, 34, 32, 0.56)' %>; font-weight: <%= conversation.unread_count > 0 ? '600' : '500' %>;">
                                        <% if (conversation.group_name) { %>
                                            <%= conversation.group_name %>
                                        <% } else if (conversation.is_ai_chat) { %>
                                            Arzani AI
                                        <% } else if (conversation.recipient) { %>
                                            <%= conversation.recipient.first_name && conversation.recipient.last_name ? 
                                                conversation.recipient.first_name + ' ' + conversation.recipient.last_name : 
                                                conversation.recipient.username || conversation.recipient.email || 'User' %>
                                        <% } else { %>
                                            Unknown User
                                        <% } %>
                                    </span>
                                    
                                    <!-- Unread count badge -->
                                    <% if (conversation.unread_count > 0) { %>
                                        <span class="inline-block bg-primary text-white text-xs rounded-full px-1.5 py-0.5 mt-1 animate-pulse">
                                            <%= conversation.unread_count %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <!-- No conversations placeholder -->
                        <div class="flex items-center justify-center px-5 py-6 text-center">
                            <div class="text-center">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-2 opacity-40">
                                    <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="rgba(36, 34, 32, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <p class="sidebar-text text-xs" style="color: rgba(36, 34, 32, 0.4);">No conversations yet</p>
                                <button onclick="window.location.href='/professionals'" class="sidebar-text text-xs mt-1 text-primary hover:opacity-80">Start chatting</button>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </nav>

        <!-- Bottom Section -->
        <div class="px-6 pb-6">
            <!-- Action Button -->
            <button class="w-full flex items-center justify-center glass-button mb-4">
                <img src="/figma design exports/icons/12-plus.svg" alt="Add" class="w-4 h-4 mr-2" style="filter: brightness(0) invert(1);">
                <span class="sidebar-text font-semibold text-white text-sm">Add New Task</span>
            </button>
            
            <!-- Settings -->
            <a href="/settings" 
               class="nav-item flex items-center glass-nav-item group mb-2"
               data-page="settings"
               data-tooltip="Settings"
               style="color: rgba(36, 34, 32, 0.56);">
                <div class="flex items-center justify-center w-6 h-6 mr-4">
                    <img src="/figma design exports/icons/10-settings.svg" alt="Settings" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                </div>
                <span class="sidebar-text font-medium transition-opacity duration-200">Settings</span>
            </a>

            <!-- Sign Out -->
            <button id="sign-out-btn" 
                    class="w-full flex items-center glass-nav-item group hover:bg-red-50"
                    style="color: rgba(36, 34, 32, 0.56);">
                <div class="flex items-center justify-center w-6 h-6 mr-4">
                    <img src="/figma design exports/icons/11-signout.svg" alt="Sign Out" class="w-6 h-6 transition-transform duration-200 group-hover:scale-110">
                </div>
                <span class="sidebar-text font-medium transition-opacity duration-200">Sign Out</span>
            </button>
        </div>
    </div>
</aside>

<!-- Sidebar Toggle Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('unified-sidebar');
    const desktopToggle = document.getElementById('desktop-sidebar-toggle');
    const mobileToggle = document.getElementById('mobile-sidebar-toggle');
    const overlay = document.getElementById('sidebar-overlay');
    
    // Load conversations for sidebar
    loadSidebarConversations();
    
    // Desktop toggle functionality
    if (desktopToggle && sidebar) {
        desktopToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            
            // Save state to localStorage
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebar-collapsed', isCollapsed.toString());
            
            // Handle arrow rotation directly with JavaScript (CSS can't reach standalone button)
            const toggleArrow = desktopToggle.querySelector('.toggle-arrow');
            if (toggleArrow) {
                // When collapsed: arrow points right (0deg) = "open" action
                // When expanded: arrow points left (180deg) = "close" action
                toggleArrow.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
            }
            
            // Adjust body padding for overlay approach
            if (isCollapsed) {
                document.body.classList.add('sidebar-collapsed');
            } else {
                document.body.classList.remove('sidebar-collapsed');
            }
        });
    }
    
    // Mobile toggle functionality
    if (mobileToggle && sidebar && overlay) {
        mobileToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('hidden');
            
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        });
        
        // Close on overlay click
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        });
    }
    
    // Restore collapsed state from localStorage
    const savedState = localStorage.getItem('sidebar-collapsed');
    if (savedState === 'true' && sidebar) {
        sidebar.classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
    }
    
    // Set initial arrow rotation based on state
    const toggleArrow = desktopToggle?.querySelector('.toggle-arrow');
    if (toggleArrow) {
        const isCollapsed = savedState === 'true';
        toggleArrow.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
    }
    
    // Handle window resize
    window.addEventListener('resize', function() {
        const isMobile = window.innerWidth < 1024;
        
        if (isMobile) {
            // Mobile mode
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
            sidebar.classList.remove('collapsed');
            document.body.style.overflow = '';
        } else {
            // Desktop mode
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Restore collapsed state if saved
            const savedState = localStorage.getItem('sidebar-collapsed');
            if (savedState === 'true') {
                sidebar.classList.add('collapsed');
            }
        }
    });
    
    // Function to load conversations for sidebar
    async function loadSidebarConversations() {
        try {
            const token = localStorage.getItem('token') || document.querySelector('meta[name="auth-token"]')?.content;
            if (!token) {
                console.log('No auth token found for sidebar conversations');
                return;
            }
            
            const response = await fetch('/api/chat/conversations', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                console.error('Failed to fetch conversations:', response.status);
                return;
            }
            
            const data = await response.json();
            if (data.success && data.conversations) {
                updateSidebarConversations(data.conversations.slice(0, 5)); // Show only top 5
            }
        } catch (error) {
            console.error('Error loading sidebar conversations:', error);
        }
    }
    
    // Function to update sidebar conversations HTML
    function updateSidebarConversations(conversations) {
        const container = document.getElementById('sidebar-conversations');
        if (!container) return;
        
        if (conversations.length === 0) {
            container.innerHTML = `
                <div class="flex items-center justify-center px-5 py-6 text-center">
                    <div class="text-center">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-2 opacity-40">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="rgba(36, 34, 32, 0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p class="sidebar-text text-xs" style="color: rgba(36, 34, 32, 0.4);">No conversations yet</p>
                        <button onclick="window.location.href='/professionals'" class="sidebar-text text-xs mt-1 text-primary hover:opacity-80">Start chatting</button>
                    </div>
                </div>
            `;
            return;
        }
        
        const conversationsHTML = conversations.map(conversation => {
            const recipient = conversation.recipient || {};
            const displayName = getConversationDisplayName(conversation);
            const profileImage = getConversationProfileImage(conversation);
            const isOnline = isUserOnline(recipient.last_active);
            const unreadCount = conversation.unread_count || 0;
            
            return `
                <div class="flex items-center px-5 py-3 rounded-xl hover:bg-black hover:bg-opacity-5 transition-all duration-200 cursor-pointer group ${unreadCount > 0 ? 'has-unread' : ''}"
                     onclick="window.location.href='/chat?conversation=${conversation.id}'">
                    <div class="relative mr-4">
                        ${profileImage}
                        <div class="absolute bottom-0 right-0 w-1.5 h-1.5 rounded-full ${isOnline ? '' : 'border border-gray-600'}" 
                             style="background: ${isOnline ? '#4ade80' : 'rgba(36, 34, 32, 0.4)'}"></div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <span class="sidebar-text text-sm font-medium block truncate" 
                              style="color: ${unreadCount > 0 ? '#242220' : 'rgba(36, 34, 32, 0.56)'}; font-weight: ${unreadCount > 0 ? '600' : '500'};">
                            ${displayName}
                        </span>
                        ${unreadCount > 0 ? `<span class="inline-block bg-primary text-white text-xs rounded-full px-1.5 py-0.5 mt-1 animate-pulse">${unreadCount}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = conversationsHTML;
    }
    
    // Helper functions
    function getConversationDisplayName(conversation) {
        if (conversation.group_name) return conversation.group_name;
        if (conversation.is_ai_chat) return 'Arzani AI';
        if (conversation.recipient) {
            const recipient = conversation.recipient;
            if (recipient.first_name && recipient.last_name) {
                return `${recipient.first_name} ${recipient.last_name}`;
            }
            return recipient.username || recipient.email || 'User';
        }
        return 'Unknown User';
    }
    
    function getConversationProfileImage(conversation) {
        const recipient = conversation.recipient || {};
        
        if (recipient.professional_picture_url) {
            return `<img src="${recipient.professional_picture_url}" alt="${recipient.username || 'User'}" class="w-6 h-6 rounded-full object-cover" onerror="this.src='/images/default-profile.png'; this.onerror=null;">`;
        }
        
        if (recipient.profile_picture) {
            return `<img src="${recipient.profile_picture}" alt="${recipient.username || 'User'}" class="w-6 h-6 rounded-full object-cover" onerror="this.src='/images/default-profile.png'; this.onerror=null;">`;
        }
        
        if (conversation.is_ai_chat) {
            return `
                <div class="w-6 h-6 rounded-full overflow-hidden flex items-center justify-center" style="background: linear-gradient(135deg, #041b76, #064fa3);">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.5 2A1.5 1.5 0 0 0 8 3.5V8l-2.4-1.6A1.5 1.5 0 0 0 3.5 8.4l1.6 2.4H1.5A1.5 1.5 0 0 0 0 12.5A1.5 1.5 0 0 0 1.5 14h3.6l-1.6 2.4A1.5 1.5 0 0 0 5.6 18.4L8 16.8v4.5A1.5 1.5 0 0 0 9.5 22A1.5 1.5 0 0 0 11 20.5V16l2.4 1.6a1.5 1.5 0 0 0 2.1-2.1L13.9 13l1.6-2.4a1.5 1.5 0 0 0-2.1-2.1L11 10V5.5A1.5 1.5 0 0 0 9.5 4z" fill="white"/>
                    </svg>
                </div>
            `;
        }
        
        return `
            <div class="w-6 h-6 rounded-full overflow-hidden flex items-center justify-center" style="background: #f2baba;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="#8B5A3C" stroke-width="2"/>
                    <circle cx="12" cy="7" r="4" stroke="#8B5A3C" stroke-width="2"/>
                </svg>
            </div>
        `;
    }
    
    function isUserOnline(lastActive) {
        if (!lastActive) return false;
        const lastActiveTime = new Date(lastActive);
        const now = new Date();
        return (now - lastActiveTime) < 5 * 60 * 1000; // 5 minutes
    }
    
    // Refresh conversations every 30 seconds
    setInterval(loadSidebarConversations, 30000);
    
    // Make functions available globally
    window.loadSidebarConversations = loadSidebarConversations;
    window.updateSidebarConversations = updateSidebarConversations;
});
</script>

<!-- Glassmorphism System -->
<link rel="stylesheet" href="/css/glassmorphism-system.css">
<script src="/js/glassmorphism-enhancer.js" defer></script>
<!-- Modern Sign-Out Modal -->
<script src="/js/modern-signout-modal.js" defer></script>
<!-- Token Counter Removal -->
<script src="/js/remove-token-counter.js" defer></script>
<script>
// Immediate token counter removal
document.addEventListener('DOMContentLoaded', function() {
    // Remove any token counter elements immediately
    function removeTokenDisplays() {
        const sidebar = document.getElementById('unified-sidebar');
        if (!sidebar) return;
        
        // Find and hide any element containing "0 Tokens", "Token", or similar
        const allElements = sidebar.querySelectorAll('*');
        allElements.forEach(element => {
            const text = element.textContent.trim();
            // Match patterns like "0 Tokens", "Tokens: 0", "Token Balance: 0", etc.
            if (/\b0\s*tokens?\b/i.test(text) || 
                /\btokens?:\s*0\b/i.test(text) ||
                /\btoken\s*balance:\s*0\b/i.test(text) ||
                (text.includes('Token') && text.includes('0') && text.length < 50)) {
                element.style.display = 'none !important';
                element.setAttribute('data-hidden-token-counter', 'true');
                console.log('Hidden token counter element:', text);
            }
        });
    }
    
    // Run immediately
    removeTokenDisplays();
    
    // Run again after a delay to catch any dynamically loaded content
    setTimeout(removeTokenDisplays, 100);
    setTimeout(removeTokenDisplays, 500);
    setTimeout(removeTokenDisplays, 1000);
});
</script>

<!-- Custom Styles for the Modern Glassmorphism Sidebar -->
<style>
/* Import Inter font */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* Global font application */
#unified-sidebar, #unified-sidebar * {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Sidebar Container Styles - Overlay Pattern */
#unified-sidebar {
    margin: 0 !important;
    padding: 0 !important;
    left: 0 !important;
    transform: none !important;
}

#unified-sidebar.sidebar-container {
    transform: none !important;
}

.sidebar-container {
    width: 280px;
    margin: 0;
    padding: 0;
    left: 0 !important;
    top: 0 !important;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    height: 100vh;
    overflow: visible !important; /* Allow toggle button to extend beyond bounds */
    position: fixed; /* Ensure proper fixed positioning */
}

.sidebar-container.collapsed {
    width: 104px;
    overflow: visible !important;
}

/* Ensure sidebar content stays within bounds except for toggle button */
.sidebar-container * {
    max-width: 100%;
    box-sizing: border-box;
}

.sidebar-container .flex-col {
    overflow-x: hidden;
    width: 100%;
    height: 100%;
}

/* Allow toggle button to extend beyond sidebar bounds when collapsed */
.sidebar-container.collapsed .flex-col {
    overflow-x: visible;
}

/* Maintain content containment for navigation area */
.sidebar-container.collapsed nav {
    overflow-x: hidden !important;
}

/* Body Padding for Overlay Sidebar */
body {
    padding-left: 280px; /* Space for sidebar overlay */
    transition: padding-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.sidebar-collapsed {
    padding-left: 104px; /* Space for collapsed sidebar */
}

/* Remove content margins - let body padding handle spacing */
#content {
    margin-left: 0;
    transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Mobile Responsive - Remove body padding and hide sidebar on mobile */
@media (max-width: 1024px) {
    body,
    body.sidebar-collapsed {
        padding-left: 0 !important;
    }
    
    #content,
    #content.sidebar-collapsed {
        margin-left: 0 !important;
    }
    
    /* Hide sidebar on mobile by default */
    #unified-sidebar {
        transform: translateX(-100%) !important;
        transition: transform 0.3s ease-in-out;
    }
    
    /* Show sidebar when active on mobile */
    #unified-sidebar.active {
        transform: translateX(0) !important;
    }
    
    .sidebar-container {
        width: 280px;
        height: 100vh;
        margin: 0;
        border-radius: 0;
    }
    
    .sidebar-container.collapsed {
        width: 280px;
    }
}

/* Sidebar Text Animation */
.sidebar-text {
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    transform: translateX(0);
}

.sidebar-container.collapsed .sidebar-text {
    opacity: 0;
    pointer-events: none;
    transform: translateX(-20px);
}

/* Collapsed state specific styles */
.sidebar-container.collapsed .dashboard-submenu {
    display: none;
}

.sidebar-container.collapsed .nav-item {
    justify-content: center;
    padding-left: 16px;
    padding-right: 16px;
    margin: 0 auto;
    width: 56px;
    overflow: hidden !important;
    white-space: nowrap;
}

.sidebar-container.collapsed .nav-item .flex {
    margin-right: 0 !important;
    justify-content: center;
}

.sidebar-container.collapsed .nav-item img,
.sidebar-container.collapsed .nav-item svg {
    margin-right: 0;
}

.sidebar-container.collapsed .nav-item .ml-auto {
    display: none;
}

/* Header section adjustments for collapsed state */
.sidebar-container.collapsed .px-6 {
    padding-left: 24px;
    padding-right: 24px;
}

/* Profile header section in collapsed state */
.sidebar-container.collapsed .flex.items-center.space-x-3 {
    justify-content: center;
    gap: 0;
}

.sidebar-container.collapsed .flex.items-center.space-x-3 .sidebar-text {
    display: none;
}

.sidebar-container.collapsed .flex.items-center.space-x-3 .relative {
    margin: 0 auto;
}

/* Ensure header section doesn't interfere with layered toggle button */
.sidebar-container.collapsed .flex.items-center.justify-between {
    position: relative;
    z-index: 1;
}

/* Fix profile image aspect ratio and prevent squashing - More specific targeting */
.sidebar-container .flex.items-center.space-x-3 .relative img.h-12.w-12 {
    width: 48px !important;
    height: 48px !important;
    object-fit: cover !important;
    object-position: center !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
    min-width: 48px;
    min-height: 48px;
    max-width: 48px;
    max-height: 48px;
}

/* Ensure navigation icons maintain consistent 24x24px size */
.sidebar-container .nav-item img.w-6.h-6,
.sidebar-container .nav-item svg.w-6.h-6 {
    width: 24px !important;
    height: 24px !important;
    flex-shrink: 0 !important;
}

/* Ensure other sidebar icons maintain their intended sizes */
.sidebar-container img.w-4.h-4 {
    width: 16px !important;
    height: 16px !important;
}

.sidebar-container img.w-6.h-6:not(.h-12) {
    width: 24px !important;
    height: 24px !important;
}

/* Messages section title in collapsed state */
.sidebar-container.collapsed .space-y-1 .px-3 {
    padding-left: 4px;
    padding-right: 4px;
    text-align: center;
    overflow: hidden;
}

/* Message items in collapsed state */
.sidebar-container.collapsed .space-y-1 .px-5 {
    padding-left: 16px;
    padding-right: 16px;
    justify-content: center;
    overflow: hidden !important;
    white-space: nowrap;
    width: 56px;
    margin: 0 auto;
}

.sidebar-container.collapsed .space-y-1 .px-5 span {
    display: none;
}

/* Center message user icons in collapsed state */
.sidebar-container.collapsed .space-y-1 .flex.items-center .relative {
    margin-right: 0 !important;
    margin: 0 auto;
}

/* Ensure message user SVGs are properly centered in collapsed state */
.sidebar-container.collapsed .space-y-1 .flex.items-center .relative .w-6.h-6 {
    margin: 0 auto;
}

.sidebar-container.collapsed .space-y-1 .flex.items-center .relative .w-6.h-6 svg {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
}

/* Ensure navigation section doesn't overflow */
.sidebar-container nav {
    overflow-x: hidden !important;
    width: 100%;
}

.sidebar-container .space-y-2 {
    overflow-x: hidden;
}

/* Allow header section to overflow when collapsed for toggle button */
.sidebar-container.collapsed .flex.flex-col.h-full > div:first-child {
    overflow-x: visible !important;
    position: relative;
    z-index: 10;
}

/* Bottom section buttons in collapsed state */
.sidebar-container.collapsed .px-6 .w-full {
    width: 48px;
    padding-left: 12px;
    padding-right: 12px;
    margin: 0 auto;
}

.sidebar-container.collapsed .px-6 .w-full span {
    display: none;
}

.sidebar-container.collapsed .px-6 .w-full img {
    margin-right: 0;
}

/* Settings and Sign Out buttons in collapsed state */
.sidebar-container.collapsed .px-6 a,
.sidebar-container.collapsed .px-6 button:not(.w-full) {
    justify-content: center !important;
    padding-left: 16px !important;
    padding-right: 16px !important;
    margin: 0 auto !important;
    width: 56px !important;
    display: flex !important;
    align-items: center !important;
}

.sidebar-container.collapsed .px-6 a .flex,
.sidebar-container.collapsed .px-6 button:not(.w-full) .flex {
    margin-right: 0 !important;
    justify-content: center !important;
    width: 24px !important;
    height: 24px !important;
}

.sidebar-container.collapsed .px-6 a span,
.sidebar-container.collapsed .px-6 button:not(.w-full) span {
    display: none !important;
}

.sidebar-container.collapsed .px-6 a img,
.sidebar-container.collapsed .px-6 button:not(.w-full) img {
    margin-right: 0 !important;
    width: 24px !important;
    height: 24px !important;
    margin: 0 auto !important;
}

/* Specific targeting for sign out button icon container */
.sidebar-container.collapsed #sign-out-btn .flex {
    width: 24px !important;
    height: 24px !important;
    justify-content: center !important;
    align-items: center !important;
    margin: 0 auto !important;
}

.sidebar-container.collapsed #sign-out-btn img {
    width: 24px !important;
    height: 24px !important;
}

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background-color: #f0f0f0; /* A neutral background to see the component */
  color: #242220;
}

.page-container {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
  box-sizing: border-box;
  min-height: 100vh;
}

.sidebar {
  max-width: 256px;
  width: 100%;
  background-color: rgba(255, 237, 224, 0.56);
  border: 0.5px solid rgba(245, 239, 235, 0.4);
  border-radius: 28px;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow: 0px 64px 64px -32px rgba(102, 37, 0, 0.56);
  padding: 24px 0;
  display: flex;
  flex-direction: column;
  gap: 17px;
  box-sizing: border-box;
}

.sidebar-header {
  display: flex;
  align-items: center;
  padding: 0 12px 0 24px;
  position: relative;
  margin-bottom: 12px;
}

.logo {
  position: absolute;
  top: -12px;
  left: 24px;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 36px; /* Space for logo */
}

.avatar-large-wrapper {
  position: relative;
  width: 48px;
  height: 48px;
  flex-shrink: 0;
}

.avatar-large-wrapper .avatar-bg {
  position: absolute;
  width: 100%;
  height: 100%;
}

.avatar-large-wrapper .avatar-img {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

.user-info {
  display: flex;
  flex-direction: column;
}

.user-name, .user-role {
  margin: 0;
}

.user-name {
  color: #242220;
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
}

.user-role {
  color: rgba(36, 34, 32, 0.4);
  font-size: 11px;
  font-weight: 500;
  line-height: 22px;
  letter-spacing: 0.4px;
}

.toggle-button {
  background: rgba(255, 237, 224, 0.56);
  border: 0.5px solid rgba(245, 239, 235, 0.32);
  border-radius: 24px;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  width: 24px;
  height: 24px;
  padding: 0;
  cursor: pointer;
  position: absolute;
  right: -12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.toggle-button img {
  transform: rotate(-90deg);
}

.divider {
  border: none;
  height: 0.5px;
  background: radial-gradient(173.07% 205.27% at 50% 50%, #432c2c 0%, rgba(80, 28, 28, 0) 100%);
  opacity: 0.24;
  margin: 0;
}

.main-nav, .messages-section {
  padding: 0 24px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.nav-title {
  color: rgba(36, 34, 32, 0.4);
  font-size: 11px;
  font-weight: 500;
  line-height: 24px;
  letter-spacing: 0.4px;
  margin: 0;
  padding: 0 20px 0 0;
}

.nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
}

.nav-item a {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 0;
  text-decoration: none;
  color: rgba(36, 34, 32, 0.56);
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
  border-radius: 12px;
  position: relative;
}

.nav-item.active > a {
  color: #242220;
}

.nav-item > a {
  padding: 16px 20px;
}

.nav-item.active {
    background-color: rgba(4, 27, 118, 0.04);
    border: 0.5px solid rgba(173, 216, 255, 0.16);
}.nav-icon {
  width: 24px;
  height: 24px;
}

.nav-icon-merged {
  position: relative;
  width: 24px;
  height: 24px;
}

.nav-icon-merged img {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.nav-arrow {
  margin-left: auto;
  transform: rotate(-180deg);
}

.sub-nav-container {
  position: relative;
  padding-left: 39px; /* Aligns with Dashboard text */
  padding-bottom: 8px;
}

.sub-nav-line {
  position: absolute;
  left: 20px; /* Aligns with Dashboard icon */
  top: -10px;
  height: calc(100% + 10px);
}

.sub-nav-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sub-nav-list a {
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 12px;
  color: rgba(36, 34, 32, 0.56);
  text-decoration: none;
  display: block;
}

.sub-nav-list li.active a {
  color: #242220;
}

.sub-nav-list li.active {
    background-color: rgba(4, 27, 118, 0.04);
    border: 0.5px solid rgba(173, 216, 255, 0.16);
    border-radius: 12px;
}.messages-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-right: 4px;
}

.add-button {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}

.add-button img {
  transform: rotate(-180deg);
}

.message-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 16px; /* Spacing between items */
  margin-top: 12px;
}

.message-item {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 14px;
  font-weight: 500;
  color: rgba(36, 34, 32, 0.56);
}

.avatar-small-wrapper {
  position: relative;
  width: 24px;
  height: 24px;
  flex-shrink: 0;
}

.avatar-merged-stack {
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  overflow: hidden;
}

.avatar-merged-stack img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.status-dot {
  position: absolute;
  right: -2px;
  bottom: -2px;
  width: 6px;
  height: 6px;
}

.status-dot.offline {
  border: 1px solid #666260;
  border-radius: 50%;
}

.promo-block {
  background-color: rgba(255, 255, 255, 0.12);
  border: 0.5px solid rgba(245, 239, 235, 0.16);
  border-radius: 28px;
  margin: 24px;
  padding: 24px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  text-align: center;
}

.promo-text {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.promo-text h3 {
  color: #242220;
  font-size: 16px;
  font-weight: 600;
  line-height: 1.5;
  letter-spacing: 0.16px;
  margin: 0;
}

.promo-text p {
  color: rgba(36, 34, 32, 0.56);
  font-size: 13px;
  font-weight: 500;
  line-height: 1.6;
  margin: 0;
}

.promo-button {
  background-color: #893027;
  border-radius: 12px;
  box-shadow: 0px 4px 24px 0px rgba(204, 100, 6, 0.3);
  padding: 11px 24px;
  border: none;
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  line-height: 1.3;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
}

.promo-button img {
  transform: rotate(-180deg);
}

/* Navigation Item Styles - Now handled by glass system */
.nav-item {
    position: relative;
    overflow: hidden;
}

.nav-item .flex {
    transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Glass system handles hover and active states */

/* Toggle Icon Rotation and Enhanced Styling */
.sidebar-container.collapsed .toggle-icon {
    transform: rotate(180deg);
    color: #041b76 !important;
}

.toggle-icon {
    color: #041b76;
    transition: all 0.3s ease;
}

/* Toggle arrow rotation and color changes */
.toggle-arrow {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.2s ease;
}

/* Toggle arrow base styles - rotation handled by JavaScript */
.toggle-arrow {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.2s ease;
}

#desktop-sidebar-toggle:hover .toggle-arrow {
    color: #064fa3;
}

/* Desktop toggle button positioning - now uses glass system */
#desktop-sidebar-toggle {
    position: absolute;
    top: 30px;
    right: -20px; /* Sticks out from sidebar right edge */
    z-index: 1002; /* Higher z-index to ensure it's above sidebar content */
    /* Ensure button isn't clipped by parent */
    transform: translateZ(0); /* Create new stacking context */
}

/* Enhanced styling when sidebar is collapsed - glass system handles this automatically */

#desktop-sidebar-toggle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(4, 27, 118, 0.15) !important;
}

/* Hover state for collapsed toggle button */
.sidebar-container.collapsed #desktop-sidebar-toggle:hover {
    transform: scale(1.05) !important;
}

/* Tooltip for collapsed sidebar */
.nav-item {
    position: relative;
}

.sidebar-container.collapsed .nav-item::after {
    content: attr(data-tooltip);
    position: absolute;
    left: calc(100% + 12px);
    top: 50%;
    transform: translateY(-50%);
    background: rgba(173, 216, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 0.5px solid rgba(173, 216, 255, 0.4);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 500;
    color: #242220;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    z-index: 1000;
    box-shadow: 0px 4px 16px rgba(102, 37, 0, 0.2);
}

.sidebar-container.collapsed .nav-item:hover::after {
    opacity: 1;
    transform: translateY(-50%) translateX(4px);
}

/* Hide tooltips on mobile */
@media (max-width: 1024px) {
    .sidebar-container.collapsed .nav-item::after {
        display: none;
    }
}

/* SVG Icon Styling */
.nav-item img,
.nav-item svg {
    opacity: 0.56;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    flex-shrink: 0;
}

.nav-item:hover img,
.nav-item:hover svg {
    opacity: 0.8;
}

.nav-item.active img,
.nav-item.active svg {
    opacity: 1;
}

/* Icon container transitions */
.nav-item .w-6.h-6 {
    transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Message user icon centering - More specific targeting */
.space-y-1 .flex.items-center .relative .w-6.h-6 {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: relative;
}

.space-y-1 .flex.items-center .relative .w-6.h-6 svg {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    display: block !important;
    margin: 0 !important;
}

/* Alternative approach for message user avatars */
.space-y-1 > div > div.relative > div.w-6 svg {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
}

/* Hide token counters in the sidebar */
#unified-sidebar .token-counter,
#unified-sidebar .tokens-counter,
#unified-sidebar .token-balance-display,
#unified-sidebar .sidebar-token-count,
#unified-sidebar .token-badge,
#unified-sidebar .user-tokens,
#unified-sidebar .profile-tokens,
#unified-sidebar .sidebar-balance,
#unified-sidebar [data-token-counter],
#unified-sidebar [data-tokens] {
    display: none !important;
}

/* Hide any text elements that might show "0 Tokens" */
#unified-sidebar *:has-text("0 Tokens"),
#unified-sidebar *:has-text("Token Balance") {
    display: none !important;
}

/* More specific hiding for potential token counter locations */
#unified-sidebar .sidebar-text:contains("Token"),
#unified-sidebar .sidebar-text:contains("token") {
    display: none !important;
}

/* Hide token-related badges in navigation */
#unified-sidebar .nav-item .badge:contains("0"),
#unified-sidebar .profile-section .token-info {
    display: none !important;
}

/* Unread conversation styling */
.has-unread {
    background: rgba(4, 27, 118, 0.06) !important;
    border-left: 2px solid #041b76;
}

.has-unread:hover {
    background: rgba(4, 27, 118, 0.1) !important;
}

/* Primary color definition for unread badges */
:root {
    --primary-color: #041b76;
}

.bg-primary {
    background-color: var(--primary-color) !important;
}

.text-primary {
    color: var(--primary-color) !important;
}

/* Sidebar conversations container max height and scroll */
#sidebar-conversations {
    max-height: 300px;
    overflow-y: auto;
}

#sidebar-conversations::-webkit-scrollbar {
    width: 4px;
}

#sidebar-conversations::-webkit-scrollbar-track {
    background: transparent;
}

#sidebar-conversations::-webkit-scrollbar-thumb {
    background: rgba(36, 34, 32, 0.2);
    border-radius: 2px;
}

#sidebar-conversations::-webkit-scrollbar-thumb:hover {
    background: rgba(36, 34, 32, 0.3);
}
</style>