<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewing History | Arzani.co.uk</title>
    <link rel="icon" href="/figma design exports/images.webp/arzani-icon-nobackground.png" type="image/png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/history.css" />
    <script type="module" src="/js/history.js"></script>
    <link rel="stylesheet" href="/css/marketplace2.css" />
</head>

<body>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // No need to check for token if we're already authenticated via session
            if (!document.cookie.includes('sessionId')) {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
            }
        });
    </script>
     <nav class="navbar navbar-light">
        <div class="handshake-logo-container">
            <img src="/public/figma design exports/logos/Arzani-logo.png" alt="Arzani.co.uk" class="logo-img">
        </div>
            <div class="navbar-container">
                <div class="navbar-icons">
                    <a href="/marketplace2" class="navbar-link" id="marketplace-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                            <path d="M216,36H40A20,20,0,0,0,20,56V200a20,20,0,0,0,20,20H216a20,20,0,0,0,20-20V56A20,20,0,0,0,216,36Zm-4,24V76H44V60ZM44,196V100H212v96Zm136-72a52,52,0,0,1-104,0,12,12,0,0,1,24,0,28,28,0,0,0,56,0,12,12,0,0,1,24,0Z"></path>
                        </svg>
                        <span>Marketplace</span>
                    </a>
                <a href="/history" class="navbar-link" id="history-link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                        <path d="M140,80v41.21l34.17,20.5a12,12,0,1,1-12.34,20.58l-40-24A12,12,0,0,1,116,128V80a12,12,0,0,1,24,0ZM128,28A99.38,99.38,0,0,0,57.24,57.34c-4.69,4.74-9,9.37-13.24,14V64a12,12,0,0,0-24,0v40a12,12,0,0,0,12,12H72a12,12,0,0,0,0-24H57.77C63,86,68.37,80.22,74.26,74.26a76,76,0,1,1,1.58,109,12,12,0,0,0-16.48,17.46A100,100,0,1,0,128,28Z"></path>
                    </svg>
                    <span>History</span>
                </a>
                <a href="/talk-to-Arzani" class="navbar-link" id="arzani-link">
                    <img src="/images/arzani-icon.svg" alt="Arzani" class="icon arzani-icon" style="width: 48px; height: 48px;" />
                    <span>Arzani</span>
                </a>
                <a href="/saved-searches" class="navbar-link" id="saved-searches-link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                        <path d="M184,28H72A20,20,0,0,0,52,48V224a12,12,0,0,0,18.36,10.18l57.63-36,57.65,36A12,12,0,0,0,204,224V48A20,20,0,0,0,184,28Zm-4,174.35-45.65-28.53a12,12,0,0,0-12.72,0L76,202.35V52H180Z"></path>
                    </svg>
                    <span>Saved Searches</span>
                </a>
                <a href="/off-market-leads" class="navbar-link" id="leads-link">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                        <path d="M148,108a12,12,0,0,1,12-12h28a12,12,0,0,1,0,24H160A12,12,0,0,1,148,108Zm40,28H168a12,12,0,0,0,0,24h20a12,12,0,0,0,0-24Zm48-80V200a20,20,0,0,1-20,20H40a20,20,0,0,1-20-20V56A20,20,0,0,1,40,36H216A20,20,0,0,1,236,56Zm-24,4H44V196H212ZM58.28,159.37A43.82,43.82,0,0,1,71.53,142a36,36,0,1,1,56.94,0,43.84,43.84,0,0,1,13.26,17.37,12,12,0,0,1-22.15,9.26C116.48,161.19,108.42,156,100,156s-16.47,5.2-19.59,12.63a12,12,0,1,1-22.13-9.26ZM88,120a12,12,0,1,0,12-12A12,12,0,0,0,88,120Z"></path>
                    </svg>
                    <span>Off Market Leads</span>
                </a>
            </div>
            <div>
                <ul class="navbar-nav"> 
                    <!-- Check if user is logged in -->
                    <script>
                      var isLoggedIn = true; // Replace with actual login check
                      if (isLoggedIn) {
                        document.write('<li class="nav-item"><a class="nav-link" href="/post-business">Post a Business</a></li>');
                      }
                    </script>
                  </ul>
                </div>
                <a href="/profile" class="btn profile-btn" id="profileBtn">Profile</a>
    </div>
    </nav>
    <main class="container mt-5">
        <div class="row mb-4">
            <div class="col">
                <h1 class="marketplace-heading text-center mb-4">Viewing History</h1>
                <div class="d-flex justify-content-end mb-3">
                    <button onclick="deleteAllHistory()" class="btn btn-outline-danger">
                        <i class="fas fa-trash-alt"></i> Clear History
                    </button>
                </div>
            </div>
        </div>

        

        <!-- History content -->
        <div class="row">
            <div class="col">
                <div id="history-container" class="card shadow-sm">
                    <!-- History table will be populated here -->
                </div>
                <div id="history-pagination" class="mt-4">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
        </div>

        <!-- No history message -->
        <div id="no-history" class="text-center mt-5 d-none">
            <i class="fas fa-history fa-3x text-muted mb-3"></i>
            <h3 class="h4">No History Yet</h3>
            <p class="text-muted">Start browsing businesses to see your history here.</p>
            <a href="/marketplace2" class="btn btn-primary mt-3">
                Browse Marketplace
            </a>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/marketplace-tracking.js"></script>
    <script type="module" src="/js/history.js"></script>
    <script src="/js/chatbox.js"></script>

    <!-- Add this script to highlight the active nav link -->
    <script>
        // Highlight the active link
        document.addEventListener('DOMContentLoaded', function() {
            const links = document.querySelectorAll('.navbar-link');
            links.forEach(link => {
                if (link.href === window.location.href) {
                    link.classList.add('active');
                }
            });
        });
    </script>

    <%- include('partials/footer') %>

    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Clear History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to clear all viewing history?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteAll()">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication check
        document.addEventListener('DOMContentLoaded', () => {
            if (!document.cookie.includes('sessionId')) {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
            }
        });

        // Delete functions
        function deleteAllHistory() {
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        async function confirmDeleteAll() {
            try {
                const response = await fetch('/api/business/history', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to clear history');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error clearing history');
            }
        }
    </script>

<!-- Add some custom styles -->
<style>
.date-group {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.date-group h3 {
    color: #2c3e50;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
}

.table {
    margin-bottom: 0;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    margin: 0 0.25rem;
}

.fa-trash {
    color: #dc3545;
}

.alert {
    border-radius: 8px;
    padding: 1.5rem;
}
</style>

</body>

</html>
</html>