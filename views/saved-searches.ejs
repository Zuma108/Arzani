<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saved Businesses</title>
    <link rel="icon" href="/figma design exports/images.webp/arzani-icon-nobackground.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/marketplace2.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <!-- Add hidden token field to match post-business pattern -->
    <% if (typeof token !== 'undefined' && token) { %>
    <input type="hidden" id="server-token" value="<%= token %>">
    <% } %>
    
    <!-- Authentication script - based on post-business pattern -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Store token in localStorage if available from server
      const tokenField = document.getElementById('server-token');
      if (tokenField && tokenField.value) {
        localStorage.setItem('token', tokenField.value);
        // Also set as cookie for server-side auth
        document.cookie = `token=${tokenField.value}; path=/; max-age=7200; SameSite=Lax`;
        console.log('Token synchronized from server');
      } else {
        // If not available from server, check localStorage
        const localToken = localStorage.getItem('token');
        if (localToken) {
          // Set as cookie for server-side auth
          document.cookie = `token=${localToken}; path=/; max-age=7200; SameSite=Lax`;
          console.log('Token synchronized from localStorage');
        }
      }
    });
    </script>
     <nav class="navbar navbar-light">
      <div class="handshake-logo-container">
          <img src="/public/figma design exports/logos/Arzani-logo.png" alt="Arzani.co.uk" class="logo-img">
      </div>
          <div class="navbar-container">
              <div class="navbar-icons">
                  <a href="/marketplace2" class="navbar-link" id="marketplace-link">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                          <path d="M216,36H40A20,20,0,0,0,20,56V200a20,20,0,0,0,20,20H216a20,20,0,0,0,20-20V56A20,20,0,0,0,216,36Zm-4,24V76H44V60ZM44,196V100H212v96Zm136-72a52,52,0,0,1-104,0,12,12,0,0,1,24,0,28,28,0,0,0,56,0,12,12,0,0,1,24,0Z"></path>
                      </svg>
                      <span>Marketplace</span>
                  </a>
              <a href="/history" class="navbar-link" id="history-link">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                      <path d="M140,80v41.21l34.17,20.5a12,12,0,1,1-12.34,20.58l-40-24A12,12,0,0,1,116,128V80a12,12,0,0,1,24,0ZM128,28A99.38,99.38,0,0,0,57.24,57.34c-4.69,4.74-9,9.37-13.24,14V64a12,12,0,0,0-24,0v40a12,12,0,0,0,12,12H72a12,12,0,0,0,0-24H57.77C63,86,68.37,80.22,74.26,74.26a76,76,0,1,1,1.58,109,12,12,0,0,0-16.48,17.46A100,100,0,1,0,128,28Z"></path>
                  </svg>
                  <span>History</span>
              </a>
              <a href="/talk-to-Arzani" class="navbar-link" id="arzani-link">
                  <img src="/images/arzani-icon.svg" alt="Arzani" class="icon arzani-icon" style="width: 48px; height: 48px;" />
                  <span>Arzani</span>
              </a>
              <a href="/saved-searches" class="navbar-link" id="saved-searches-link">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                      <path d="M184,28H72A20,20,0,0,0,52,48V224a12,12,0,0,0,18.36,10.18l57.63-36,57.65,36A12,12,0,0,0,204,224V48A20,20,0,0,0,184,28Zm-4,174.35-45.65-28.53a12,12,0,0,0-12.72,0L76,202.35V52H180Z"></path>
                  </svg>
                  <span>Saved Searches</span>
              </a>
              <a href="/off-market-leads" class="navbar-link" id="leads-link">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 256" class="icon" aria-hidden="true">
                      <path d="M148,108a12,12,0,0,1,12-12h28a12,12,0,0,1,0,24H160A12,12,0,0,1,148,108Zm40,28H168a12,12,0,0,0,0,24h20a12,12,0,0,0,0-24Zm48-80V200a20,20,0,0,1-20,20H40a20,20,0,0,1-20-20V56A20,20,0,0,1,40,36H216A20,20,0,0,1,236,56Zm-24,4H44V196H212ZM58.28,159.37A43.82,43.82,0,0,1,71.53,142a36,36,0,1,1,56.94,0,43.84,43.84,0,0,1,13.26,17.37,12,12,0,0,1-22.15,9.26C116.48,161.19,108.42,156,100,156s-16.47,5.2-19.59,12.63a12,12,0,1,1-22.13-9.26ZM88,120a12,12,0,1,0,12-12A12,12,0,0,0,88,120Z"></path>
                  </svg>
                  <span>Off Market Leads</span>
              </a>
          </div>
          <div>
              <ul class="navbar-nav"> 
                  <!-- Check if user is logged in -->
                  <script>
                    var isLoggedIn = true; // Replace with actual login check
                    if (isLoggedIn) {
                      document.write('<li class="nav-item"><a class="nav-link" href="/post-business">Post a Business</a></li>');
                    }
                  </script>
                </ul>
              </div>
              <a href="/profile" class="btn profile-btn" id="profileBtn">Profile</a>
  </div>
  </nav>
</head>
<body>
    
    <!-- Add this near the top of the file, after any existing scripts -->
    <script>
    // Enhanced authentication debugging
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Saved-searches template loaded');
      
      const token = localStorage.getItem('token');
      console.log('üîç Token in localStorage:', token ? 'Present' : 'Missing');
      
      // Check cookies
      const cookies = document.cookie.split('; ');
      const tokenCookie = cookies.find(cookie => cookie.startsWith('token='));
      console.log('üîç Token in cookies:', tokenCookie ? 'Present' : 'Missing');
      
      // Ensure token synchronization
      if (token) {
        // Set token as cookie with proper attributes
        document.cookie = `token=${token}; path=/; max-age=7200; SameSite=Lax`;
        console.log('üîç Token synced from localStorage to cookie');
      } else {
        console.log('üîç No token found in localStorage');
        // Check if we have the token in the page
        const pageToken = '<%= typeof token !== "undefined" ? token : "" %>';
        if (pageToken && pageToken !== '<%= typeof token !== "undefined" ? token : "" %>') {
          localStorage.setItem('token', pageToken);
          console.log('üîç Token synced from page to localStorage');
        } else {
          console.warn('üîç No token in page variables either');
        }
      }
      
      // Add debug info to page
      if (!token && !tokenCookie) {
        const debugInfo = document.createElement('div');
        debugInfo.className = 'alert alert-warning';
        debugInfo.innerHTML = `
          <h4>Authentication Debug Info</h4>
          <p>No authentication token found. This might be why you're seeing this page without being logged in.</p>
          <p><a href="/login2?returnTo=/saved-searches" class="btn btn-primary">Go to login page</a></p>
        `;
        document.querySelector('.container').prepend(debugInfo);
      }
    });
    </script>

    <!-- Add this script to highlight the active nav link -->
    <script>
        // Highlight the active link
        document.addEventListener('DOMContentLoaded', function() {
            const links = document.querySelectorAll('.navbar-link');
            links.forEach(link => {
                if (link.href === window.location.href) {
                    link.classList.add('active');
                }
            });
        });
    </script>

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="marketplace-heading">Saved Businesses</h1>
            <button class="btn btn-primary" onclick="exportToGoogleDrive()">
                <i class="bi bi-cloud-upload"></i> Export to Google Drive
            </button>
        </div>
        
        <div id="saved-listings" class="row row-cols-1 row-cols-md-3 g-4">
            <!-- Saved businesses will be loaded here -->
        </div>

        <div id="no-saved" class="text-center my-5 d-none">
            <h3>No saved businesses yet</h3>
            <p>Browse the marketplace and save businesses you're interested in.</p>
            <a href="/marketplace2" class="btn btn-primary mt-3">Browse Marketplace</a>
        </div>
    </div>

    <!-- Add export status modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Exporting to Google Drive</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div>
                    </div>
                    <p id="exportStatus">Starting export...</p>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/saved-searches.js"></script>
</body>
</html>
