{
  "name": "My workflow 16",
  "nodes": [
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "197uchkUU-m5ePCYdz4qJZpApCBaHGrEl4epyysicE50",
          "mode": "list",
          "cachedResultName": "Blog sheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/197uchkUU-m5ePCYdz4qJZpApCBaHGrEl4epyysicE50/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/197uchkUU-m5ePCYdz4qJZpApCBaHGrEl4epyysicE50/edit#gid=0"
        },
        "options": {}
      },
      "id": "4086759c-9733-4a32-85cb-6adfb40bf20a",
      "name": "Read Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [
        1060,
        660
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "N771RNEAERs6VMmz",
          "name": "Google Sheets account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5000/api/blog/n8n/webhook",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Webhook-Token",
              "value": "djbfjwqjodwjonwqjodnjbiwijeu239298edwsudh2nbwjmwdnakwl"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"action\": \"blog_generated\",\n  \"postData\": {\n    \"title\": \"{{ $json.title }}\",\n    \"slug\": \"{{ $json.slug }}\",\n    \"meta_description\": \"{{ $json.metaDescription }}\",\n    \"content\": \"{{ $json.content }}\",\n    \"categories\": \"{{ $json.categoriesAndTags }}\",\n    \"author\": \"{{ $json.author }}\",\n    \"hero_image\": \"{{ $json.hero_image || '' }}\",\n    \"updated_at\": \"{{ $now.iso }}\"\n  }\n}",
        "options": {
          "allowUnauthorizedCerts": true,
          "redirect": {
            "followRedirects": true
          },
          "timeout": 60000,
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "6342c3bf-989a-46f4-abad-1beb811952c5",
      "name": "Notify Blog System",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1340,
        1100
      ]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "documentId": {
          "__rl": true,
          "value": "1iYrCRw8cs7lmJfpYrY7kDkE-yJM2qlUuzPi5M2Km_0g",
          "mode": "list",
          "cachedResultName": "SEO Key words",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iYrCRw8cs7lmJfpYrY7kDkE-yJM2qlUuzPi5M2Km_0g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1iYrCRw8cs7lmJfpYrY7kDkE-yJM2qlUuzPi5M2Km_0g/edit#gid=0"
        },
        "event": "rowAdded",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTrigger",
      "typeVersion": 1,
      "position": [
        -300,
        320
      ],
      "id": "8b4bcf36-4ec6-4de6-8aed-312fc54e4f4a",
      "name": "Niche Input",
      "credentials": {
        "googleSheetsTriggerOAuth2Api": {
          "id": "1BzktJqnwzot73jc",
          "name": "Google Sheets Trigger account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract and process AI-generated content from Gemini\nconst geminiResponse = $input.item.json;\n\n// Initialize variables\nlet generatedContent = '';\nlet metaDescription = '';\nlet metaTitle = '';\nlet blogTitle = $json.TITLES || '';\nlet manualImageUrl = $json[\"Image URL\"] || $json[\"Image URLs\"] || '';\n\ntry {\n  // Extract content from Gemini response\n  if (geminiResponse && geminiResponse.candidates && \n      geminiResponse.candidates[0] && \n      geminiResponse.candidates[0].content && \n      geminiResponse.candidates[0].content.parts && \n      geminiResponse.candidates[0].content.parts[0]) {\n    generatedContent = geminiResponse.candidates[0].content.parts[0].text || '';\n  } else {\n    throw new Error('Invalid Gemini response structure');\n  }\n  \n  // Properly clean the content - remove any code blocks tags\n  generatedContent = generatedContent.replace(/^```html\\s*/i, '').replace(/```$/i, '').trim();\n  \n  // Look for meta information that may have been included by Gemini\n  const metaTitleMatch = generatedContent.match(/<meta-title>(.*?)<\\/meta-title>/i);\n  const metaDescMatch = generatedContent.match(/<meta-description>(.*?)<\\/meta-description>/i);\n  \n  // Extract meta information if found\n  if (metaTitleMatch && metaTitleMatch[1]) {\n    metaTitle = metaTitleMatch[1].trim();\n    // Remove the meta title tag from the content\n    generatedContent = generatedContent.replace(/<meta-title>.*?<\\/meta-title>/i, '');\n  }\n  \n  if (metaDescMatch && metaDescMatch[1]) {\n    metaDescription = metaDescMatch[1].trim();\n    // Remove the meta description tag from the content\n    generatedContent = generatedContent.replace(/<meta-description>.*?<\\/meta-description>/i, '');\n  }\n  \n  // If meta description wasn't found, generate one from first paragraph\n  if (!metaDescription) {\n    const firstParagraphMatch = generatedContent.match(/<p>(.*?)<\\/p>/is);\n    if (firstParagraphMatch && firstParagraphMatch[1]) {\n      metaDescription = firstParagraphMatch[1].replace(/<[^>]*>/g, '').substring(0, 160);\n      if (metaDescription.length === 160) metaDescription += '...';\n    } else {\n      metaDescription = `${blogTitle} - Insights from Arzani's expert business marketplace`.substring(0, 160);\n    }\n  }\n  \n  // If meta title wasn't found, use the blog title\n  if (!metaTitle) {\n    metaTitle = blogTitle;\n  }\n  \n  // Enhance the content with internal linking if none exists\n  if (!generatedContent.includes('class=\"internal-link\"')) {\n    // Add internal links section before the final paragraph\n    const lastParagraphPos = generatedContent.lastIndexOf('</p>');\n    if (lastParagraphPos !== -1) {\n      const internalLinksSection = `\n<div class=\"mt-8 p-6 bg-gray-50 border border-gray-200 rounded-xl\">\n  <h3 class=\"text-xl font-bold mb-4 text-gray-900\">Optimize Your Business</h3>\n  <p class=\"text-gray-700 mb-4\">Looking to implement these strategies for your business? Explore our resources:</p>\n  <ul class=\"space-y-3\">\n    <li class=\"flex items-start\">\n      <svg class=\"h-6 w-6 text-primary mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\n      </svg>\n      <div class=\"ml-3\">\n        <h4 class=\"font-semibold text-gray-900\">Business Valuation</h4>\n        <p class=\"text-sm text-gray-600 mb-1\">Understand what your business is worth in today's market.</p>\n        <a href=\"/services/business-valuation\" class=\"text-sm font-medium text-primary internal-link\">Get a Valuation →</a>\n      </div>\n    </li>\n    <li class=\"flex items-start\">\n      <svg class=\"h-6 w-6 text-primary mt-0.5 flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\n      </svg>\n      <div class=\"ml-3\">\n        <h4 class=\"font-semibold text-gray-900\">Seller Resources</h4>\n        <p class=\"text-sm text-gray-600 mb-1\">Learn how to prepare your business for a successful sale.</p>\n        <a href=\"/seller-questionnaire\" class=\"text-sm font-medium text-primary internal-link\">Seller Questionnaire →</a>\n      </div>\n    </li>\n  </ul>\n</div>\n`;\n      \n      // Insert the internal links section before the last paragraph's closing tag\n      generatedContent = generatedContent.slice(0, lastParagraphPos) + internalLinksSection + generatedContent.slice(lastParagraphPos);\n    }\n  }\n  \n  // Ensure all images have appropriate styling for 600px width\n  generatedContent = generatedContent.replace(/<img\\s+([^>]*?)>/gi, (match, attributes) => {\n    // Don't add width/style if already specified\n    if (attributes.includes('width=') || attributes.includes('style=')) {\n      return match;\n    }\n    return `<img ${attributes} style=\"max-width: 600px; height: auto; margin: 2rem auto; display: block; border: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 8px;\">`;\n  });\n  \n} catch (e) {\n  console.error('Error parsing Gemini response:', e);\n  generatedContent = `<p>Error generating content: ${e.message}</p>`;\n}\n\n// Determine the title to use for the slug (prefer meta title if available)\nconst titleForSlug = metaTitle || blogTitle || '';\n\n// Generate a clean slug from the title\nlet cleanSlug = '';\nif (titleForSlug) {\n  // Remove the \"| Arzani\" part if present\n  const titleWithoutBranding = titleForSlug.replace(/\\s*\\|\\s*Arzani\\s*$/i, '');\n  \n  cleanSlug = titleWithoutBranding.toLowerCase()\n    .replace(/[^\\w\\s-]/g, '')   // Remove special characters\n    .replace(/\\s+/g, '-')       // Replace spaces with hyphens\n    .replace(/-+/g, '-')        // Replace multiple hyphens with single hyphen\n    .replace(/^-+|-+$/g, '');   // Remove leading/trailing hyphens\n} else {\n  cleanSlug = 'blog-post-' + Date.now(); // Fallback only if no title is available\n}\n\n// Format the data for database insertion/update\nconst blogPost = {\n  title: metaTitle || blogTitle || 'Untitled Blog Post',\n  metaDescription: metaDescription || '',\n  author: 'Arzani Team',\n  content: generatedContent,\n  categoriesAndTags: $json.Keywords || '',\n  slug: cleanSlug,\n  hero_image: manualImageUrl || null,\n  imageUrls: manualImageUrl ? [manualImageUrl] : [], // Include manual image URL if available\n  publishDate: new Date().toISOString().split('T')[0],\n  status: 'AI Generated - Ready for Review',\n  processedAt: new Date().toISOString(),\n  aiGenerated: true,\n  rowNumber: $json.row_number || 0\n};\n\nreturn { json: blogPost };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        1100
      ],
      "id": "93f2ec57-e291-4651-9a3a-ee984e0b96fa",
      "name": "Process AI Content"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={\n  \"contents\": [\n    {\n      \"role\": \"user\",\n      \"parts\": [\n        {\n          \"text\": \"You are a professional blog writer for Arzani, a UK business marketplace focused on helping people buy and sell businesses. Write a comprehensive, well-structured blog post with the following specifications:\\n\\nTitle: {{ $json.TITLES }} and write a blog post in first person.  -UK\\n\\nTarget audience: UK business owners, potential business buyers, and small to medium sized businesses. Some are looking to buy their businesses or some are looking to sell their businesses based on the topic choose one target audience\\n\\nTopic/Focus: Should I sell my business? -UK\\n\\nKey points to include: Professional business valuation, market trends, optimization strategies\\n\\n---INTERNAL LINKING REQUIREMENTS---\\n1. Research and include at least 3-4 internal links to other Arzani content within your blog post\\n2. Use the following format for internal links: <a href=\\\"https://arzani.co.uk/path/to/page\\\" class=\\\"internal-link\\\">descriptive anchor text</a>\\n3. Link to relevant content such as:\\n   - Related blog posts about business valuation\\n   - The seller questionnaire page: https://www.arzani.co.uk/seller-questionnaire\\n   - Service pages about business optimization\\n   - Business buying guide for potential buyers\\n4. Use natural, contextual anchor text that includes relevant keywords\\n5. Place links strategically within paragraphs where they provide additional value to readers\\n\\n---META INFORMATION---\\n1. Create a compelling meta title (50-60 characters) that incorporates primary keywords and encourages clicks\\n2. Write an engaging meta description (150-160 characters) that summarizes the post's value proposition\\n3. Include these at the beginning of your response in the following format:\\n   <meta-title>Your Optimized Title Here | Arzani</meta-title>\\n   <meta-description>Your compelling meta description that entices clicks and includes keywords.</meta-description>\\n\\n---FORMATTING AND STYLE---\\nTone: Professional but conversational, authoritative but accessible\\n\\nFormat: Use proper HTML formatting with h2 and h3 headings, paragraphs, bullet points where appropriate, and 1-2 call-to-actions encouraging readers to use Arzani's business valuation services.\\n\\nLength: 1000-1500 words\\n\\nStructure: Include an introduction, 3-5 main sections with subheadings, and a conclusion.\\n\\nMake sure to include relevant UK-specific market information and regulations where appropriate. Use British English spelling and terminology. DO NOT include ```html and ``` tags at the start or end of the outputted HTML.\"\n        }\n      ]\n    }\n  ],\n  \"generationConfig\": {\n    \"temperature\": 0.7,\n    \"topK\": 40,\n    \"topP\": 0.95,\n    \"maxOutputTokens\": 8192\n  }\n}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [
        660,
        1100
      ],
      "id": "00aa0d90-2396-4834-8218-d1f5eaa7929b",
      "name": "AI Agent"
    }
  ],
  "connections": {
    "Niche Input": {
      "main": [
        [
          {
            "node": "Keyword Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Process AI Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process AI Content": {
      "main": [
        [
          {
            "node": "Notify Blog System",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "callerPolicy": "any"
  },
  "versionId": "c4edf31e-6f32-479a-92d9-50a2df53cdee",
  "meta": {
    "instanceId": "cac95b8f2cca08f3c3fb9bbdc4eeaea309a93918ef2ad6aaa8f7f20747b99afa"
  },
  "id": "Ei5nRYbcgGzOzWbl",
  "tags": []
}