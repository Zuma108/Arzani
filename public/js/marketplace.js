import { initializeTracking } from './marketplace-tracking.js';

// Add loading state

let isLoading = false;

export async function loadPage(pageNumber = 1, filters = {}) {
  // Parse numeric values properly
  const query = new URLSearchParams({
    page: pageNumber.toString(),
    location: filters.location || '',
    industries: filters.industries || '',
    priceMin: filters.priceRange?.split('-')[0] || '',
    priceMax: filters.priceRange?.split('-')[1] || '',
    revenueRange: filters.revenueRange || '',
    cashflowRange: filters.cashflowRange || ''
  }).toString();

  try {
    const response = await fetch(`/api/business/listings?${query}`);
    if (!response.ok) throw new Error('Network response was not ok');
    const data = await response.json();
    renderBusinesses(data.businesses);
    renderPaginationControls(pageNumber, data.totalPages);
  } catch (error) {
    console.error('Error loading businesses:', error);
    document.getElementById('listings-container').innerHTML =
      '<div class="alert alert-danger">Error loading businesses. Please try again.</div>';
  }
}

function renderBusinesses(businesses) {
  const listingsContainer = document.getElementById('listings-container');
  listingsContainer.innerHTML = '';

  if (businesses.length === 0) {
    listingsContainer.innerHTML = '<p>No businesses found.</p>';
    return;
  }

  businesses.forEach(business => {
    const businessCard = document.createElement('div');
    businessCard.className = 'col-md-4 mb-4';

    // Create image carousel for multiple images with save button overlay
    const imagesHtml = business.images && business.images.length > 0 
        ? `<div class="card-image-carousel">
            <button class="save-business-btn" data-business-id="${business.id}">
                <i class="bi bi-bookmark"></i>
            </button>
            <div class="carousel-inner">
                ${business.images.map((image, index) => `
                    <div class="carousel-item ${index === 0 ? 'active' : ''}" data-index="${index}">
                        <img src="/uploads/${image}" class="card-img-top" alt="${business.business_name}" loading="lazy">
                    </div>
                `).join('')}
            </div>
            ${business.images.length > 1 ? `
                <div class="carousel-controls">
                    <button class="carousel-control prev" data-direction="prev">‹</button>
                    <div class="carousel-indicators">
                        ${business.images.map((_, index) => `
                            <button class="carousel-indicator ${index === 0 ? 'active' : ''}" 
                                    data-index="${index}"></button>
                        `).join('')}
                    </div>
                    <button class="carousel-control next" data-direction="next">›</button>
                </div>
            ` : ''}
        </div>`
        : `<div class="card-image-carousel">
            <button class="save-business-btn" data-business-id="${business.id}">
                <i class="bi bi-bookmark"></i>
            </button>
            <img src="/images/default-business.jpg" class="card-img-top" alt="Default business image">
           </div>`;

    businessCard.innerHTML = `
      <div class="card h-100">
          ${imagesHtml}
          <div class="card-body d-flex flex-column">
            <div class="listing-header mb-1">
              <span class="badge">${business.industry}</span>
              <h2 class="business-name mb-0">${business.business_name}</h2>
            </div>

            <div class="price-metrics-container pt-0">
              <div class="price-section">
                <span class="metric-label">Asking Price</span>
                <span class="price">£${parseFloat(business.price).toLocaleString()}</span>
              </div>
              
              <div class="metrics-pair">
                <div class="metric-item" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Cash Flow: The net amount of cash generated by the business">
                  <span class="metric-label">CF</span>
                  <div class="metric-value">£${parseFloat(business.cash_flow || 0).toLocaleString()}</div>
                </div>
                <div class="metric-separator"></div>
                <div class="metric-item" data-bs-toggle="tooltip" data-bs-placement="top" 
                     title="Gross Revenue: Total income before deducting expenses">
                  <span class="metric-label">GR</span>
                  <div class="metric-value">£${parseFloat(business.gross_revenue || 0).toLocaleString()}</div>
                </div>
              </div>
            </div>

            <div class="mt-auto d-flex justify-content-between gap-2">
              <button class="btn btn-primary flex-grow-1 view-details-btn" 
                      data-business-id="${business.id}"
                      onclick="window.location.href='/businesses/${business.id}'">
                View Details
              </button>
              <button class="btn btn-outline-secondary flex-grow-1 contact-btn" 
                      data-business-id="${business.id}"
                      data-bs-toggle="modal" 
                      data-bs-target="#contactModal">
                Contact Seller
              </button>
            </div>
          </div>
      </div>
    `;
    listingsContainer.appendChild(businessCard);

    // Check if business is saved and update button state
    checkSavedStatus(business.id);

    // Add carousel functionality if multiple images
    if (business.images && business.images.length > 1) {
        initializeCarousel(businessCard.querySelector('.card-image-carousel'));
    }
  });

  // Initialize tooltips
  const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

  initializeContactButtons();
}

// Add this new function to initialize contact buttons
function initializeContactButtons() {
  document.querySelectorAll('.contact-btn').forEach(button => {
    button.addEventListener('click', function() {
      const businessId = this.getAttribute('data-business-id');
      document.getElementById('businessId').value = businessId;
      const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
      contactModal.show();
    });
  });
}

function initializeCarousel(carouselElement) {
    if (!carouselElement) return;

    const items = carouselElement.querySelectorAll('.carousel-item');
    const indicators = carouselElement.querySelectorAll('.carousel-indicator');
    const totalItems = items.length;
    let currentIndex = 0;

    // Handle control buttons
    carouselElement.querySelectorAll('.carousel-control').forEach(control => {
        control.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent card click
            const direction = control.dataset.direction;
            if (direction === 'prev') {
                currentIndex = (currentIndex - 1 + totalItems) % totalItems;
            } else {
                currentIndex = (currentIndex + 1) % totalItems;
            }
            updateCarousel();
        });
    });

    // Handle indicators
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent card click
            currentIndex = index;
            updateCarousel();
        });
    });

    function updateCarousel() {
        items.forEach((item, index) => {
            item.classList.toggle('active', index === currentIndex);
        });
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentIndex);
        });
    }

    // Add touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    carouselElement.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    carouselElement.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, { passive: true });

    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left - next
                currentIndex = (currentIndex + 1) % totalItems;
            } else {
                // Swipe right - previous
                currentIndex = (currentIndex - 1 + totalItems) % totalItems;
            }
            updateCarousel();
        }
    }
}

function renderPaginationControls(currentPage, totalPages) {
    const paginationContainer = document.getElementById('pagination');
    if (!paginationContainer) return;
    
    paginationContainer.innerHTML = '';
    
    // Create pagination wrapper
    const paginationNav = document.createElement('nav');
    const paginationList = document.createElement('ul');
    paginationList.className = 'pagination justify-content-center';
    
    // Previous button
    const prevItem = createPaginationItem(currentPage - 1, '«', currentPage > 1, totalPages);
    paginationList.appendChild(prevItem);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageItem = createPaginationItem(i, i.toString(), true, totalPages, i === currentPage);
        paginationList.appendChild(pageItem);
    }
    
    // Next button
    const nextItem = createPaginationItem(currentPage + 1, '»', currentPage < totalPages);
    paginationList.appendChild(nextItem);
    
    paginationNav.appendChild(paginationList);
    paginationContainer.appendChild(paginationNav);
}

function createPaginationItem(pageNumber, text, enabled, totalPages, isActive = false) {
    const li = document.createElement('li');
    li.className = `page-item ${!enabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
    
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.textContent = text;
    
    if (enabled) {
        a.addEventListener('click', (e) => {
            e.preventDefault();
            loadPage(pageNumber);
        });
    }
    
    li.appendChild(a);
    return li;
}

// Initialize immediately when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Clear any existing content
    const listingsContainer = document.getElementById('listings-container');
    if (listingsContainer) {
        listingsContainer.innerHTML = '';
    }
    
    // Load first page of businesses
    loadPage(1);
    initializeTracking();
});

document.addEventListener('DOMContentLoaded', function () {
  // Handle Contact Seller button clicks
  document.querySelectorAll('.contact-btn').forEach(function(button) {
    button.addEventListener('click', function() {
      const businessId = button.getAttribute('data-business-id');
      document.getElementById('businessId').value = businessId;
      const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
      contactModal.show();
    });
  });

document.addEventListener('DOMContentLoaded', function() {
  const offMarketLink = document.getElementById('leads-link');
  
  offMarketLink.addEventListener('click', async function(e) {
      e.preventDefault();
      
      try {
          // Check user subscription status
          const response = await fetch('/api/check-subscription', {
              method: 'GET',
              headers: {
                  'Content-Type': 'application/json'
              },
              credentials: 'include' // Include cookies
          });
          
          const data = await response.json();
          
          if (data.subscriptionType === 'platinum') {
              // If user has platinum subscription, redirect to off-market leads
              window.location.href = '/off-market-leads';
          } else {
              // If user doesn't have required subscription, show upgrade modal
              window.location.href = '/off-market-leads';
          }
      } catch (error) {
          console.error('Error checking subscription:', error);
          window.location.href = '/off-market-leads';
      }
  });
});

  // Handle form submission
  const contactForm = document.getElementById('contactForm');
  contactForm.addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = {
      businessId: document.getElementById('businessId').value,
      firstName: document.getElementById('firstName').value,
      lastName: document.getElementById('lastName').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      timeframe: document.getElementById('timeframe').value,
      message: document.getElementById('message').value,
      newsletter: document.getElementById('newsletter').checked,
    };

    fetch('/contact-seller', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData),
    })
    .then(function(response) {
      if (response.ok) {
        alert('Your message has been sent!');
        contactForm.reset();
        const contactModal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
        contactModal.hide();
      } else {
        alert('There was a problem sending your message.');
      }
    })
    .catch(function(error) {
      console.error('Error:', error);
    });
  });
});

// Add save functionality
document.addEventListener('click', async (e) => {
    const saveBtn = e.target.closest('.save-business-btn');
    if (saveBtn) {
        e.preventDefault(); // Prevent event bubbling
        const businessId = saveBtn.dataset.businessId;
        
        try {
            if (saveBtn.classList.contains('saved')) {
                // Unsave
                const response = await fetch(`/api/business/unsave/${businessId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    saveBtn.classList.remove('saved');
                    saveBtn.querySelector('i').classList.replace('bi-bookmark-fill', 'bi-bookmark');
                }
            } else {
                // Save
                const response = await fetch('/api/business/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ businessId })
                });

                if (response.ok) {
                    saveBtn.classList.add('saved');
                    saveBtn.querySelector('i').classList.replace('bi-bookmark', 'bi-bookmark-fill');
                }
            }
        } catch (error) {
            console.error('Error saving/unsaving business:', error);
            alert('Please login to save businesses');
        }
    }
});

// Add function to check saved status
async function checkSavedStatus(businessId) {
    try {
        const token = localStorage.getItem('token');
        if (!token) return; // Skip if no token

        const response = await fetch(`/api/business/is-saved/${businessId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                localStorage.removeItem('token'); // Clear invalid token
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        const saveBtn = document.querySelector(`.save-business-btn[data-business-id="${businessId}"]`);
        if (saveBtn) {
            if (data.isSaved) {
                saveBtn.classList.add('saved');
                saveBtn.querySelector('i').classList.replace('bi-bookmark', 'bi-bookmark-fill');
            }
        }
    } catch (error) {
        console.error('Error checking saved status:', error);
    }
}