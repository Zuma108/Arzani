<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Management - Arzani</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/profile.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <%- include('../partials/navbar') %>
    
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar -->
            <aside class="w-full md:w-64 shrink-0">
                <div class="bg-white rounded-lg shadow-md p-5">
                    <div class="flex items-center space-x-3 mb-6">
                        <img 
                            src="<%= user.profile_picture || '/images/default-profile.png' %>" 
                            alt="<%= user.username %>" 
                            class="w-12 h-12 rounded-full object-cover border border-gray-200"
                        >
                        <div>
                            <h2 class="font-semibold text-lg"><%= user.username %></h2>
                            <p class="text-sm text-gray-500">Member since <%= new Date(user.created_at).toLocaleDateString() %></p>
                        </div>
                    </div>
                    
                    <nav class="space-y-1">
                        <a href="/profile" class="block px-3 py-2 rounded-md hover:bg-gray-50 text-gray-700">
                            Account Settings
                        </a>
                        <a href="/profile/subscription" class="block px-3 py-2 bg-blue-50 text-blue-600 rounded-md font-medium">
                            Subscription
                        </a>
                        <a href="/saved-searches" class="block px-3 py-2 rounded-md hover:bg-gray-50 text-gray-700">
                            Saved Searches
                        </a>
                        <a href="/history" class="block px-3 py-2 rounded-md hover:bg-gray-50 text-gray-700">
                            Browsing History
                        </a>
                        <a href="/logout" class="block px-3 py-2 rounded-md hover:bg-gray-50 text-gray-700 mt-4 border-t pt-4">
                            Sign Out
                        </a>
                    </nav>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-1">
                <h1 class="text-2xl font-bold mb-6">Subscription Management</h1>
                
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <!-- Current Subscription -->
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-medium">Current Plan</h2>
                            <% if (subscription && subscription.status === 'active') { %>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    Active
                                </span>
                            <% } else if (subscription && subscription.status === 'canceled') { %>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    Cancelled
                                </span>
                            <% } else { %>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    Free Plan
                                </span>
                            <% } %>
                        </div>
                        
                        <% if (subscription && (subscription.status === 'active' || subscription.status === 'canceled')) { %>
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br <%= subscription.plan === 'platinum' ? 'from-purple-500 to-indigo-700' : 'from-yellow-500 to-orange-500' %> rounded-lg flex items-center justify-center text-white">
                                    <%= subscription.plan === 'platinum' ? 'P' : 'G' %>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold"><%= subscription.plan === 'platinum' ? 'Platinum' : 'Gold' %> Plan</h3>
                                    <p class="text-gray-500">
                                        £<%= subscription.price %> per month
                                    </p>
                                    <% if (subscription.status === 'active') { %>
                                        <p class="text-sm text-gray-500 mt-1">
                                            Your next payment is on <%= new Date(subscription.currentPeriodEnd).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                                        </p>
                                    <% } else { %>
                                        <p class="text-sm text-gray-500 mt-1">
                                            Your subscription will end on <%= new Date(subscription.currentPeriodEnd).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                                        </p>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex flex-wrap gap-3">
                                <% if (subscription.status === 'active' && !subscription.cancelAtPeriodEnd) { %>
                                    <button id="cancel-subscription" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                        Cancel Subscription
                                    </button>
                                    <% if (subscription.plan === 'gold') { %>
                                        <a href="/checkout-platinum" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Upgrade to Platinum
                                        </a>
                                    <% } %>
                                <% } else if (subscription.status === 'canceled' || subscription.cancelAtPeriodEnd) { %>
                                    <a href="<%= subscription.plan === 'gold' ? '/checkout-gold' : '/checkout-platinum' %>" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        Resubscribe
                                    </a>
                                <% } %>
                            </div>
                        <% } else { %>
                            <!-- Free plan display -->
                            <div class="flex items-start gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-gray-400 to-gray-600 rounded-lg flex items-center justify-center text-white">
                                    F
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold">Free Plan</h3>
                                    <p class="text-gray-500">
                                        Limited features available
                                    </p>
                                    <div class="mt-4">
                                        <a href="/off-market-leads" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            Upgrade Your Plan
                                        </a>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- Plan Comparison -->
                    <div class="p-6">
                        <h2 class="text-lg font-medium mb-4">Plan Comparison</h2>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Feature
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Free
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Gold
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Platinum
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            Database Access
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            Limited
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ID Verification
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            Arzani Insights
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            Off Market Leads
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            Deal Emails
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            ✗
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            ✓
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Payment History -->
                    <% if (subscription && subscription.status === 'active' && invoices && invoices.length > 0) { %>
                        <div class="p-6 border-t">
                            <h2 class="text-lg font-medium mb-4">Payment History</h2>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Date
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Amount
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Status
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Receipt
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <% invoices.forEach(invoice => { %>
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <%= new Date(invoice.invoice_date).toLocaleDateString('en-GB') %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    £<%= invoice.amount %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                                                        <%= invoice.status %>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <% if (invoice.receipt_url) { %>
                                                        <a href="<%= invoice.receipt_url %>" target="_blank" class="text-blue-600 hover:text-blue-900">
                                                            View Receipt
                                                        </a>
                                                    <% } else { %>
                                                        N/A
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>
    
    <%- include('../partials/footer') %>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cancelBtn = document.getElementById('cancel-subscription');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    if (confirm('Are you sure you want to cancel your subscription? Your benefits will continue until the end of your billing period.')) {
                        try {
                            const response = await fetch('/stripe/cancel-subscription', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                alert('Your subscription has been canceled and will end at the end of your current billing period.');
                                window.location.reload();
                            } else {
                                alert('There was an error canceling your subscription. Please try again.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('There was an error canceling your subscription. Please try again.');
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
